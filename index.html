<!DOCTYPE html>
<html lang="pt-BR">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>Controle de Estoque</title>

  <!-- Firebase SDKs -->
  <script src="https://www.gstatic.com/firebasejs/11.9.1/firebase-app-compat.js"></script>
  <script src="https://www.gstatic.com/firebasejs/11.9.1/firebase-auth-compat.js"></script>
  <script src="https://www.gstatic.com/firebasejs/11.9.1/firebase-firestore-compat.js"></script>
  <!-- jsPDF para gerar PDF -->
  <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.5.1/jspdf.umd.min.js"></script>

  <style>
    body { font-family: Arial, sans-serif; padding: 20px; max-width: 600px; margin: auto; }
    input, button, select { padding: 10px; margin: 5px 0; width: 100%; }
    .card { border: 1px solid #ccc; padding: 10px; margin-bottom: 10px; }
    .tabs button { padding: 10px; margin-right: 10px; }
    .tabs button.active { background: #ccc; }
    .ocultar { display: none; }
    .popup-overlay { position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: rgba(0,0,0,0.6); display: flex; align-items: center; justify-content: center; z-index: 9999; }
    .popup-content { background: #fff; padding: 20px; border-radius: 10px; width: 90%; max-width: 600px; max-height: 80vh; overflow-y: auto; }
    .popup-content input { width: 60px; }
    .popup-header { display: flex; justify-content: space-between; align-items: center; }
  </style>
</head>
<body>
  <h1>Gerenciar Estoque da Cozinha</h1>

  <div id="login-section">
    <input type="email" id="email" placeholder="Email" />
    <input type="password" id="password" placeholder="Senha" />
    <button onclick="login()">Entrar</button>
    <p id="login-error" style="color:red"></p>
  </div>

  <div id="app-section" style="display:none">
    <h2>Bem-vindo ao Sistema!</h2>
    <p>Login realizado com sucesso!</p>

    <div class="tabs">
      <button onclick="mostrarAba('estoque')" id="btn-estoque">Estoque</button>
      <button onclick="mostrarAba('producao')" id="btn-producao">ProduÃ§Ã£o</button>
    </div>

    <div id="aba-estoque" style="display:block">
      <h3>Itens do Estoque</h3>
      <select id="filtro-fornecedor" onchange="filtrarEstoque()"></select>
      <div id="estoque-list"></div>
      <button onclick="abrirPopupConfirmacaoCompras()">ðŸ“‹ Gerar Lista de Compras (PDF)</button>
    </div>

    <div id="aba-producao" style="display:none">
      <h3>Cadastro de ProduÃ§Ã£o</h3>
      <input type="text" id="item-producao" placeholder="Nome do item" />
      <input type="text" id="unidade-producao" placeholder="Unidade (kg, L, porÃ§Ã£o...)" />
      <input type="number" id="quantidade-producao" placeholder="Quantidade" />
      <button onclick="salvarProducao()">Salvar item produzido</button>
      <div id="producao-list"></div>
    </div>
  </div>

  <div id="popup-confirmacao" class="popup-overlay" style="display:none">
    <div class="popup-content">
      <div class="popup-header">
        <h3>Confirmar Lista de Compras</h3>
        <button onclick="document.getElementById('popup-confirmacao').style.display='none'">âœ–</button>
      </div>
      <div id="lista-confirmacao"></div>
      <button onclick="gerarPDFConfirmado()">Gerar PDF</button>
    </div>
  </div>

  <script>
    const firebaseConfig = {
      apiKey: "AIzaSyBJbyfICQFEfzL7EKbaH-08mQmZWOM8FhU",
      authDomain: "appestoquecozinha.firebaseapp.com",
      projectId: "appestoquecozinha",
      storageBucket: "appestoquecozinha.appspot.com",
      messagingSenderId: "705934517110",
      appId: "1:705934517110:web:b4d5b79059feb7e6485057"
    };
    firebase.initializeApp(firebaseConfig);
    const auth = firebase.auth();
    const db = firebase.firestore();

    function login() {
      const email = document.getElementById("email").value;
      const password = document.getElementById("password").value;
      auth.signInWithEmailAndPassword(email, password)
        .then((userCredential) => {
          const user = userCredential.user;
          document.getElementById("login-section").style.display = "none";
          document.getElementById("app-section").style.display = "block";
          carregarEstoque(user.uid);
        })
        .catch((error) => {
          document.getElementById("login-error").innerText = "Erro ao fazer login: " + error.message;
        });
    }

    function carregarEstoque(uid) {
      db.collection("estoque").where("uid", "==", uid).get().then(snapshot => {
        const lista = document.getElementById("estoque-list");
        const fornecedores = new Set();
        const itens = [];
        snapshot.forEach(doc => {
          const data = doc.data();
          data.id = doc.id;
          itens.push(data);
          fornecedores.add(data.fornecedor);
        });

        const filtro = document.getElementById("filtro-fornecedor");
        filtro.innerHTML = '<option value="todos">Todos os Fornecedores</option>' +
          Array.from(fornecedores).map(f => `<option value="${f}">${f}</option>`).join("");

        listarEstoque(itens, filtro.value);
        filtro.onchange = () => listarEstoque(itens, filtro.value);
      });
    }

    function listarEstoque(itens, filtro) {
      const lista = document.getElementById("estoque-list");
      lista.innerHTML = "";
      itens.filter(item => filtro === "todos" || item.fornecedor === filtro).forEach(item => {
        const div = document.createElement("div");
        div.className = "card";
        div.innerHTML = `<strong>${item.item}</strong><br>${item.atual ?? 0} ${item.unidade}`;
        lista.appendChild(div);
      });
    }
  </script>
</body>
</html>
