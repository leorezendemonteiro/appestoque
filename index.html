<!DOCTYPE html>
<html lang="pt-BR">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>App Estoque Cozinha</title>
    <link rel="icon" type="image/png" sizes="192x192" href="https://i.imgur.com/sDGp7Gb.jpeg">
    <link rel="apple-touch-icon" href="https://i.imgur.com/sDGp7Gb.jpeg">
    <meta name="theme-color" content="#ffffff">
    <link rel="manifest" href="manifest.webmanifest">
    <script src="https://cdn.tailwindcss.com"></script>
    <link href="https://cdn.jsdelivr.net/npm/daisyui@4.4.2/dist/full.css" rel="stylesheet" type="text/css" />
    <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.5.1/jspdf.umd.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf-autotable/3.5.28/jspdf.plugin.autotable.min.js"></script>
    <link rel="stylesheet" href="public/styles.css">
    <script src="https://cdn.jsdelivr.net/npm/autosize@4.0.2/dist/autosize.min.js"></script>
</head>
<body class='min-h-screen bg-cover bg-center bg-no-repeat' style='background-image: url(https://i.imgur.com/8VJvCPI.jpeg);'>

    <div id="app-container" class="w-full max-w-2xl mx-auto py-8 px-4">

        <div id="login-view" class="card bg-base-100 shadow-xl max-w-md mx-auto">
            <div class="card-body">
            <form id="login-form" class="form-layout">
                <div class="form-group sm:col-span-2">
                    <label for="login-email" class="label"><span class="label-text">Email</span></label>
                    <input type="email" id="login-email" name="email" class="form-input" required>
                </div>
                <div class="form-group sm:col-span-2">
                    <label for="login-password" class="label"><span class="label-text">Senha</span></label>
                    <input type="password" id="login-password" name="password" class="form-input" required>
                </div>
                <div class="btn-center">
                    <button type="submit" class="btn btn-primary btn-base">Entrar</button>
                    <button type="button" id="show-signup-btn" class="btn btn-link btn-base">Não tenho conta, quero me cadastrar</button>
                </div>
            </form>
            </div>
        </div>

        <div id="signup-view" class="card bg-base-100 shadow-xl hidden max-w-md mx-auto">
            <div class="card-body">
            <h1 class="text-2xl font-bold text-center mb-6">Criar Nova Conta</h1>
            <form id="signup-form" class="form-layout">
                <div class="form-group sm:col-span-2">
                    <label for="signup-email" class="label"><span class="label-text">Email</span></label>
                    <input type="email" id="signup-email" name="email" class="form-input" required>
                </div>
                <div class="form-group sm:col-span-2">
                    <label for="signup-password" class="label"><span class="label-text">Senha</span></label>
                    <input type="password" id="signup-password" name="password" class="form-input" required>
                </div>
                <div class="btn-center">
                    <button type="submit" class="btn btn-success btn-base">Cadastrar</button>
                    <button type="button" id="show-login-btn" class="btn btn-link btn-base">Já tenho uma conta</button>
                </div>
            </form>
            </div>
        </div>

        <div id="main-app-view" class="hidden">
            <header class="navbar bg-base-100 shadow-lg mb-8 rounded-box">
                <div class="flex justify-between items-center">
                    <div>
                        <h1 class="text-xl font-bold text-gray-800">App de Gestão</h1>
                        <p id="user-email" class="text-xs text-gray-500"></p>
                    </div>
                        <!-- ALTERACAO: Menu de Administracao -->
                        <a id="admin-link" href="#admin" class="hidden text-sm text-primary mr-2">Administração</a>
                    <button id="logout-btn" class="btn btn-error btn-sm">Sair</button>
                </div>
            </header>
            <div id="dashboard-view" class="hidden grid grid-cols-1 md:grid-cols-2 gap-4 mb-8">
                <div class="card bg-base-100 shadow-xl hover:shadow-2xl transition-transform hover:-translate-y-1">
                    <div class="card-body flex items-center">
                        <div class="flex items-center space-x-4">
                            <svg class="w-8 h-8 text-primary" fill="none" stroke="currentColor" stroke-width="1.5" viewBox="0 0 24 24">
                                <rect x="3" y="3" width="18" height="18" rx="2" ry="2" />
                                <path d="M3 9h18M9 3v6" />
                            </svg>
                            <div>
                                <p class="text-sm">Estoque Total</p>
                                <p id="dashboard-total-stock" class="text-2xl font-bold">0</p>
                            </div>
                        </div>
                    </div>
                </div>
                <div class="card bg-base-100 shadow-xl hover:shadow-2xl transition-transform hover:-translate-y-1">
                    <div class="card-body flex items-center">
                        <div class="flex items-center space-x-4">
                            <svg class="w-8 h-8 text-error" fill="none" stroke="currentColor" stroke-width="1.5" viewBox="0 0 24 24">
                                <path d="M12 2L2 22h20L12 2z" />
                                <path d="M12 8v6m0 4h.01" />
                            </svg>
                            <div>
                                <p class="text-sm">Itens em Falta</p>
                                <p id="dashboard-items-missing" class="text-2xl font-bold">0</p>
                            </div>
                        </div>
                    </div>
                </div>
                <div class="card bg-base-100 shadow-xl hover:shadow-2xl transition-transform hover:-translate-y-1">
                    <div class="card-body flex items-center">
                        <div class="flex items-center space-x-4">
                            <svg class="w-8 h-8 text-success" fill="none" stroke="currentColor" stroke-width="1.5" viewBox="0 0 24 24">
                                <circle cx="12" cy="12" r="9" />
                                <path d="M9 12l2 2 4-4" />
                            </svg>
                            <div>
                                <p class="text-sm">Produção do Dia</p>
                                <p id="dashboard-daily-production" class="text-2xl font-bold">0</p>
                            </div>
                        </div>
                    </div>
                </div>
            </div>

            <div class="mb-8">
                <div class="border-b border-gray-200">
                    <div class="bg-white/80 rounded-lg shadow-md px-4 py-2 text-black">
                        <nav id="tabs-container" class="menu-principal" aria-label="Tabs">
                            <div class="flex flex-wrap gap-2 w-full">
                                <button data-tab="stock" class="tab-button whitespace-nowrap px-4 py-2 border-b-2 font-medium text-sm text-black hover:bg-white/90">Estoque</button>
                                <button data-tab="production" class="tab-button whitespace-nowrap px-4 py-2 border-b-2 font-medium text-sm text-black hover:bg-white/90">Produção</button>
                                <button data-tab="reports" class="tab-button whitespace-nowrap px-4 py-2 border-b-2 font-medium text-sm text-black hover:bg-white/90">Relatórios</button>
                                <button data-tab="fichas" class="tab-button whitespace-nowrap px-4 py-2 border-b-2 font-medium text-sm text-black hover:bg-white/90">Ficha Técnica</button>
                                <button data-tab="fc" class="tab-button whitespace-nowrap px-4 py-2 border-b-2 font-medium text-sm text-black hover:bg-white/90">Cadastro FC/Preços</button>
                            </div>
                            <div class="flex flex-wrap gap-2 w-full mt-1">
                                <button data-tab="cmv" class="tab-button whitespace-nowrap px-4 py-2 border-b-2 font-medium text-sm text-black hover:bg-white/90">Cálculo do CMV</button>
                                <button data-tab="balance" class="tab-button whitespace-nowrap px-4 py-2 border-b-2 font-medium text-sm text-black hover:bg-white/90">Balanço de Estoque</button>
                            </div>
                        </nav>
                    </div>
                </div>
            </div>

            <div id="app-content">
                <div id="tab-stock" class="tab-content space-y-8">
                    <div class="card bg-base-100 shadow-xl p-6">
                        <h2 class="text-lg font-semibold mb-4 text-gray-700">Adicionar Produto ao Estoque</h2>
                        <form id="add-item-form" class="form-layout">
                            <input type="text" id="product-name" placeholder="Nome do Produto" class="form-input sm:col-span-2" required>
                            <select id="product-supplier" class="supplier-select form-input" size="1"></select>
                            <input type="number" id="product-quantity" placeholder="Qtd. Atual" class="form-input" step="any" required>
                            <input type="number" id="product-min" placeholder="Qtd. Mínima" class="form-input" step="any">
                            <input type="number" id="product-ideal" placeholder="Qtd. Ideal" class="form-input" step="any">
                            <select id="product-unit" class="form-input">
                                <option>un</option> <option>kg</option> <option>g</option> <option>lt</option> <option>ml</option>
                            </select>
                            <input type="number" id="product-price" placeholder="Preço Unitário (R$)" step="0.01" class="form-input">
                            <div class="btn-center">
                                <button type="submit" class="btn btn-primary btn-base">Adicionar</button>
                            </div>
                        </form>
                    </div>
                    <div class="card bg-base-100 shadow-xl p-6">
                        <div class="flex justify-between items-center mb-4">
                            <h2 class="text-lg font-semibold text-gray-700">Itens no Estoque</h2>
                            <select id="supplier-filter" class="supplier-select shadow-sm appearance-none border rounded py-2 px-3 text-gray-700 bg-white text-sm" size="1"></select>
                        </div>
                        <div id="stock-list" class="space-y-3"></div>
                    </div>
                    
                    <div class="card bg-base-100 shadow-xl p-6">
                        <h2 class="text-lg font-semibold mb-4 text-gray-700">Gerenciar Fornecedores</h2>
                        <form id="add-supplier-form" class="form-layout mb-4">
                            <input type="text" id="supplier-name" placeholder="Nome do Fornecedor" class="form-input sm:col-span-2" required>
                            <div class="btn-center">
                                <button type="submit" class="btn btn-primary btn-base">Adicionar</button>
                            </div>
                        </form>
                        <div class="border-t pt-4">
                            <h3 class="text-md font-medium mb-3 text-gray-600">Fornecedores Cadastrados</h3>
                            <div class="scroll-container-fornecedor">
                                <div id="suppliers-list" class="space-y-2"></div>
                            </div>
                        </div>
                    </div>
                </div>

                <div id="tab-production" class="tab-content space-y-8">
                    <div class="card bg-base-100 shadow-xl p-6">
                        <h2 class="text-lg font-semibold mb-4 text-gray-700">Adicionar Item à Produção</h2>
                        <form id="add-production-form" class="form-layout">
                            <input type="text" id="production-name" placeholder="Nome do Produto" class="form-input sm:col-span-2" required>
                             <select id="production-sector" class="form-input">
                                 <option value="COZINHA">COZINHA</option>
                                 <option value="PARRILLA">PARRILLA</option>
                             </select>
                            <input type="number" id="production-quantity" placeholder="Qtd" class="form-input" step="any" required>
                            <select id="production-unit" class="form-input">
                                <option>porção</option> <option>kg</option> <option>lt</option> <option>un</option>
                            </select>
                            <div class="btn-center">
                                <button type="submit" class="btn btn-success btn-base">Adicionar</button>
                            </div>
                        </form>
                    </div>
                    <div class="card card-producao bg-base-100 shadow-xl w-full p-6">
                        <div class="flex justify-between items-center mb-4">
                            <h2 class="text-lg font-semibold text-gray-700">Itens em Produção</h2>
                            <select id="sector-filter" class="shadow-sm appearance-none border rounded py-2 px-3 text-gray-700 bg-white text-sm">
                                <option value="TODOS">TODOS</option>
                                <option value="COZINHA">COZINHA</option>
                                <option value="PARRILLA">PARRILLA</option>
                            </select>
                        </div>
                        <div id="production-list" class="space-y-3"></div>
                    </div>

                    <div class="bg-white p-6 rounded-xl shadow-lg">
                        <h2 class="text-lg font-semibold mb-4 text-gray-700">Gerar Etiqueta de Produto</h2>
                        <form id="etiqueta-form" class="form-layout">
                            <select id="etiqueta-produto-select" class="form-input"></select>
                            <input type="text" id="etiqueta-produto-custom" placeholder="Digitar item personalizado" class="form-input hidden">
                            <input type="date" id="etiqueta-producao" class="form-input">
                            <input type="date" id="etiqueta-validade" class="form-input">
                            <div class="flex items-center space-x-4 w-full sm:col-span-2">
                                <label class="flex items-center"><input type="radio" name="etiqueta-tipo" value="Resfriado" class="mr-1" checked>Resfriado</label>
                                <label class="flex items-center"><input type="radio" name="etiqueta-tipo" value="Congelado" class="mr-1">Congelado</label>
                            </div>
                            <div class="btn-center">
                                <button type="submit" class="btn btn-primary btn-base">Gerar Etiqueta</button>
                            </div>
                        </form>
                    </div>

                      <div class="card bg-base-100 shadow-xl p-6">
                        <h2 class="text-lg font-semibold mb-4 text-gray-700">Observações - Parrilla</h2>
                        <div class="form-layout mb-4">
                            <input type="date" id="parrilla-obs-date" class="form-input" />
                            <textarea id="parrilla-obs-text" maxlength="500" rows="3" class="form-input resize-y" placeholder="Observações do dia"></textarea>
                            <div class="btn-center">
                              <button id="save-parrilla-obs" class="btn btn-error btn-base">Salvar Observações</button>
                            </div>
                        </div>
                        <div id="parrilla-obs-list" class="space-y-3"></div>
                    </div>

                    <div class="bg-white p-6 rounded-xl shadow-lg">
                        <h2 class="text-lg font-semibold mb-4 text-gray-700">Observações - Cozinha</h2>
                        <div class="form-layout mb-4">
                            <input type="date" id="cozinha-obs-date" class="form-input" />
                            <textarea id="cozinha-obs-text" maxlength="500" rows="3" class="form-input resize-y" placeholder="Observações do dia"></textarea>
                            <div class="btn-center">
                                <button id="save-cozinha-obs" class="btn btn-success btn-base">Salvar Observações</button>
                            </div>
                        </div>
                        <div id="cozinha-obs-list" class="space-y-3"></div>
                    </div>
                </div>

                <div id="tab-reports" class="tab-content space-y-8">
                     <div class="bg-white p-6 rounded-xl shadow-lg">
                         <h2 class="text-lg font-semibold mb-4 text-gray-700">Relatórios de Estoque</h2>
                         <div class="flex flex-col sm:flex-row gap-4">
                              <button id="generate-stock-report-btn" class="flex-1 bg-gray-600 hover:bg-gray-700 text-white font-bold py-2 px-4 rounded">Relatório Geral de Estoque (PDF)</button>
                              <button id="generate-shopping-list-btn" class="flex-1 bg-orange-500 hover:bg-orange-600 text-white font-bold py-2 px-4 rounded">Gerar Lista de Compras</button>
                         </div>
                     </div>
                     <div class="bg-white p-6 rounded-xl shadow-lg">
                         <h2 class="text-lg font-semibold mb-4 text-gray-700">Relatórios de Produção</h2>
                         <div class="flex flex-col sm:flex-row gap-4">
                             <button id="generate-kitchen-report-btn" class="flex-1 bg-teal-600 hover:bg-teal-700 text-white font-bold py-2 px-4 rounded">Produção Cozinha (PDF)</button>
                             <button id="generate-parrilla-report-btn" class="flex-1 bg-red-700 hover:bg-red-800 text-white font-bold py-2 px-4 rounded">Produção Parrilla (PDF)</button>
                         </div>
                     </div>
                     <div id="report-display-area" class="bg-white rounded-xl shadow-lg hidden"></div>
                </div>
                <div id="tab-fichas" class="tab-content space-y-8">
                    <div class="bg-white p-6 rounded-xl shadow-lg">
                        <h2 class="text-lg font-semibold mb-4 text-gray-700">Ficha Técnica</h2>
                        <p class="text-sm text-gray-600 mb-2">CMV aplicado: <span id="current-cmv-display">0%</span></p>
                        <form id="ficha-form" class="form-layout">
                            <input type="text" id="ficha-nome" placeholder="Nome do Prato" class="form-input" required>
                            <input type="text" id="ficha-categoria" placeholder="Categoria/Grupo" class="form-input" required>
                            <input type="number" id="ficha-rendimento" placeholder="Rendimento" class="form-input" required>
                            <input type="text" id="ficha-imagem" placeholder="URL da Imagem (opcional)" class="form-input">
                            <div class="sm:col-span-2">
                                <h3 class="font-semibold text-gray-700 mb-2">Ingredientes</h3>
                                <datalist id="ingredientes-options"></datalist>
                                <div class="grid grid-cols-4 sm:grid-cols-8 gap-2 font-semibold text-sm mb-1">
                                    <span>Ingrediente</span>
                                    <span>Qtd. Líquida</span>
                                    <span>Unidade</span>
                                    <span>FC</span>
                                    <span>Qtd. Bruta</span>
                                    <span>Custo Unitário</span>
                                    <span>Custo Total</span>
                                    <span></span>
                                </div>
                                <div id="ingredientes-container" class="space-y-1"></div>
                                <button type="button" id="add-ingrediente-btn" class="mt-2 bg-gray-500 hover:bg-gray-600 text-white font-bold py-1 px-2 rounded btn-base">+ Adicionar ingrediente</button>
                            </div>
                            <div class="form-layout sm:col-span-2">
                                <p>Custo total do prato: R$ <span id="custo-total-prato">0.00</span></p>
                                <p>Custo por porção: R$ <span id="custo-por-porcao">0.00</span></p>
                                <p>Preço sugerido: R$ <span id="preco-sugerido">0.00</span></p>
                                <input type="number" id="preco-real" placeholder="Preço real praticado (opcional)" step="0.01" class="form-input">
                <p>CMV real: <span id="cmv-real-display">0%</span></p>
                                <p>Margem de lucro estimada: <span id="margem-lucro-display">0%</span></p>
                            </div>
                            <div class="btn-center">
                              <button type="submit" class="btn btn-primary btn-base">Salvar Ficha Técnica</button>
                            </div>
                        </form>
                        <div id="fichas-list" class="space-y-3 mt-4"></div>
                    </div>
                </div>
                <div id="tab-fc" class="tab-content space-y-8">
                    <div class="card bg-base-100 shadow-xl p-6">
                        <h2 class="text-lg font-semibold mb-4 text-gray-700">Cadastro de FC e Preços</h2>
                        <form id="fc-form" class="form-layout">
                            <select id="fc-ingrediente" class="form-input"></select>
                            <input type="number" id="fc-fator" step="any" placeholder="Fator de Correção" class="form-input" required>
                            <input type="number" id="fc-preco" step="any" placeholder="Preço de Referência (R$)" class="form-input" required>
                            <input type="text" id="fc-unidade" placeholder="Unidade" class="form-input" required>
                            <div class="btn-center">
                              <button type="submit" class="btn btn-primary btn-base">Salvar</button>
                            </div>
                        </form>
                        <div id="fc-list" class="space-y-2 mt-4"></div>
                    </div>
                </div>
                <div id="tab-cmv" class="tab-content space-y-8">
                      <div class="card bg-base-100 shadow-xl p-6">
                        <h2 class="text-lg font-semibold mb-4 text-gray-700">Cálculo do CMV</h2>
                        <form id="cmv-form" class="form-layout">
                            <input type="number" id="cmv-estoque-inicial" placeholder="Estoque Inicial (R$)" step="0.01" class="form-input" required>
                            <input type="number" id="cmv-compras" placeholder="Compras do Mês (R$)" step="0.01" class="form-input" required>
                            <input type="number" id="cmv-estoque-final" placeholder="Estoque Final (R$)" step="0.01" class="form-input" required>
                            <input type="number" id="cmv-despesas-fixas" placeholder="Despesas Fixas (R$)" step="0.01" class="form-input" required>
                            <input type="number" id="cmv-mao-obra" placeholder="Mão de Obra (R$)" step="0.01" class="form-input" required>
                            <input type="number" id="cmv-receita-bruta" placeholder="Receita Bruta do Mês (R$)" step="0.01" class="form-input" required>
                        </form>
                        <div id="cmv-manual-container" class="mt-4 hidden">
                            <input type="number" id="cmv-manual-input" placeholder="CMV (%) manual" step="0.01" class="form-input">
                        </div>
                        <div class="flex flex-wrap gap-2 mt-4">
                              <button id="calcular-cmv-btn" class="btn btn-primary">Calcular CMV</button>
                              <button id="importar-cmv-btn" class="btn btn-success">Importar este CMV para Fichas Técnicas</button>
                              <button id="mostrar-manual-btn" class="btn btn-neutral">Inserir CMV manual</button>
                        </div>
                    <div id="cmv-results" class="mt-4 space-y-1 text-gray-700"></div>
                    </div>
                </div>
                <div id="tab-balance" class="tab-content space-y-8">
                      <div class="card bg-base-100 shadow-xl p-6">
                        <div class="flex space-x-2 mb-4">
                              <button data-view="novo" class="balance-view-button btn btn-primary btn-sm">Realizar Balanço</button>
                            <button data-view="historico" class="balance-view-button bg-gray-200 px-2 py-1 rounded text-sm">Histórico de Balanços</button>
                        </div>
                        <div id="balance-new-view">
                            <div class="flex justify-between mb-2">
                                <div class="space-x-2 items-center flex">
                                    <button class="balance-group-button btn btn-primary btn-sm" data-bgroup="fornecedor">Por Fornecedor</button>
                                    <button class="balance-group-button bg-gray-200 px-2 py-1 rounded text-sm" data-bgroup="cozinha">Produção Cozinha</button>
                                    <button class="balance-group-button bg-gray-200 px-2 py-1 rounded text-sm" data-bgroup="parrilla">Produção Parrilla</button>
                                    <select id="balance-supplier-filter" class="supplier-select shadow-sm appearance-none border rounded py-1 px-2 text-gray-700 bg-white text-sm hidden"></select>
                                </div>
                                <div class="space-x-2">
                                    <button id="balance-summary-btn" class="bg-gray-500 text-white px-2 py-1 rounded text-sm">Resumo</button>
                                    <button id="apply-balance-btn" class="bg-green-600 text-white px-2 py-1 rounded text-sm" disabled>Aplicar Balanço</button>
                                    <button id="balance-pdf-btn" class="bg-gray-600 text-white px-2 py-1 rounded text-sm">Exportar PDF</button>
                                </div>
                            </div>
                            <div id="balance-table-container"></div>
                        </div>
                        <div id="balance-history-view" class="hidden">
                            <div class="flex gap-2 mb-2">
                                <input type="month" id="history-date-filter" class="border rounded p-1 text-sm">
                                <select id="history-type-filter" class="border rounded p-1 text-sm">
                                    <option value="">Todos</option>
                                    <option value="fornecedor">Por Fornecedor</option>
                                    <option value="cozinha">Produção Cozinha</option>
                                    <option value="parrilla">Produção Parrilla</option>
                                </select>
                            </div>
                            <div id="balance-history-list" class="balanco-scroll"></div>
                        </div>

                    </div>
                </div>
            </div>
        </div>
        
        <div id="admin-view" class="hidden p-6 bg-white bg-opacity-80 rounded-xl shadow-lg">
            <h2 class="text-lg font-semibold mb-4">Administração</h2>

            <div id="superadmin-section" class="hidden">
                <form id="add-company-form" class="form-layout mb-4">
                    <input type="text" id="empresa-razao" placeholder="Razão Social" class="form-input" required>
                    <input type="text" id="empresa-cnpj" placeholder="CNPJ" class="form-input" required>
                    <input type="text" id="empresa-endereco" placeholder="Endereço" class="form-input" required>
                    <input type="email" id="empresa-admin-email" placeholder="Email do Admin" class="form-input" required>
                    <input type="password" id="empresa-admin-senha" placeholder="Senha do Admin" class="form-input" required>
                    <div class="btn-center">
                      <button type="submit" class="btn btn-primary btn-base">Salvar</button>
                    </div>
                </form>
                <div id="empresas-list" class="space-y-2"></div>
            </div>

            <div id="admin-section" class="hidden">
                <h3 class="font-semibold mb-2">Usuários</h3>
                <form id="add-user-form" class="form-layout mb-4">
                    <input type="email" id="novo-usuario-email" placeholder="Email" class="form-input" required>
                    <input type="password" id="novo-usuario-senha" placeholder="Senha" class="form-input" required>
                    <div class="btn-center">
                      <button type="submit" class="btn btn-primary btn-base">Adicionar Usuário</button>
                    </div>
                </form>
                <div id="usuarios-list" class="space-y-1 mb-4"></div>
                <h3 class="font-semibold mb-2">Importar Estoque</h3>
                <input type="file" id="import-file" accept=".csv,.xlsx" class="mb-4">
            </div>

            <button id="voltar-main" class="mt-4 bg-gray-500 text-white px-3 py-1 rounded text-sm">Voltar</button>
        </div>
        <div id="history-modal" class="hidden fixed inset-0 bg-black bg-opacity-50 flex items-center justify-center z-50"></div>
        <div id="balance-summary-modal" class="hidden fixed inset-0 bg-black bg-opacity-50 flex items-center justify-center z-50">
            <div id="balance-summary" class="bg-white p-4 rounded shadow-lg max-h-full overflow-auto w-full max-w-2xl"></div>
        </div>
        <div id="message-container" class="fixed top-5 right-5 text-sm font-bold z-50"></div>

    </div>
    <script type="module">
        import { initializeApp } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-app.js";
        import { getAuth, createUserWithEmailAndPassword, signInWithEmailAndPassword, onAuthStateChanged, signOut, getIdTokenResult } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-auth.js";
        import { getFirestore, collection, doc, onSnapshot, addDoc, deleteDoc, updateDoc, setDoc, getDocs, getDoc, query, where, collectionGroup, increment } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-firestore.js";

        const firebaseConfig = {
            apiKey: "AIzaSyBJbyfICQFEfzL7EKbaH-08mQmZWOM8FhU",
            authDomain: "appestoquecozinha.firebaseapp.com",
            projectId: "appestoquecozinha",
            storageBucket: "appestoquecozinha.appspot.com",
            messagingSenderId: "705934517110",
            appId: "1:705934517110:web:b4d5b79059feb7e6485057"
        };

        const app = initializeApp(firebaseConfig);
        const auth = getAuth(app);
        const db = getFirestore(app);
        let companyPath = [];
        let userRole = 'usuario';
        let lastLoginPassword = '';
        
        let appState = {
            stockItems: [],
            productionItems: [],
            suppliers: [],
            suppliersLoaded: false,
            currentSupplierFilter: 'TODOS',
            currentSectorFilter: 'TODOS',
            unsubscribeStock: null,
            unsubscribeProduction: null,
            unsubscribeSuppliers: null,
            shoppingListItems: [],
            obsParrilla: [],
            obsCozinha: [],
            unsubscribeObsParrilla: null,
            unsubscribeObsCozinha: null,
            editingObs: { parrilla: null, cozinha: null },
            fichasTecnicas: [],
            unsubscribeFichasTecnicas: null,
            currentCMV: 0,
            unsubscribeCMV: null,
            fcValues: {},
            unsubscribeFC: null,
            currentBalanceGroup: 'fornecedor',
            currentBalanceSupplierFilter: 'TODOS',
            balanceHistoryRecords: [],
            tempBalancePrompted: false
        };

        const loginView = document.getElementById("login-view");
        const signupView = document.getElementById("signup-view");
        const mainAppView = document.getElementById("main-app-view");
        const tabsContainer = document.getElementById("tabs-container");
        const tabContents = document.querySelectorAll(".tab-content");
        const dashboardView = document.getElementById("dashboard-view");
        const dashboardTotalStock = document.getElementById("dashboard-total-stock");
        const dashboardItemsMissing = document.getElementById("dashboard-items-missing");
        const dashboardDailyProduction = document.getElementById("dashboard-daily-production");
        const loginForm = document.getElementById("login-form");
        const signupForm = document.getElementById("signup-form");
        const addItemForm = document.getElementById("add-item-form");
        const addProductionForm = document.getElementById("add-production-form");
        const addSupplierForm = document.getElementById("add-supplier-form");
        const showSignupBtn = document.getElementById("show-signup-btn");
        const showLoginBtn = document.getElementById("show-login-btn");
        const logoutBtn = document.getElementById("logout-btn");
        const messageContainer = document.getElementById("message-container");
        const generateStockReportBtn = document.getElementById("generate-stock-report-btn");
        const generateShoppingListBtn = document.getElementById("generate-shopping-list-btn");
        const generateKitchenReportBtn = document.getElementById("generate-kitchen-report-btn");
        const generateParrillaReportBtn = document.getElementById("generate-parrilla-report-btn");
        const stockListDiv = document.getElementById("stock-list");
        const productionListDiv = document.getElementById("production-list");
        const etiquetaForm = document.getElementById("etiqueta-form");
        const etiquetaProdutoSelect = document.getElementById("etiqueta-produto-select");
        const etiquetaProdutoCustom = document.getElementById("etiqueta-produto-custom");
        const etiquetaProducaoInput = document.getElementById("etiqueta-producao");
        const etiquetaValidadeInput = document.getElementById("etiqueta-validade");
        const supplierFilter = document.getElementById("supplier-filter");
        const sectorFilter = document.getElementById("sector-filter");
        const suppliersListDiv = document.getElementById("suppliers-list");
        const reportDisplayArea = document.getElementById("report-display-area");
        const parrillaObsDate = document.getElementById("parrilla-obs-date");
        const parrillaObsText = document.getElementById("parrilla-obs-text");
        const saveParrillaObsBtn = document.getElementById("save-parrilla-obs");
        const parrillaObsListDiv = document.getElementById("parrilla-obs-list");
        const cozinhaObsDate = document.getElementById("cozinha-obs-date");
        const cozinhaObsText = document.getElementById("cozinha-obs-text");
        const saveCozinhaObsBtn = document.getElementById("save-cozinha-obs");
        const cozinhaObsListDiv = document.getElementById("cozinha-obs-list");
        autosize(document.querySelectorAll('textarea'));
        const fichaForm = document.getElementById("ficha-form");
        const fichasListDiv = document.getElementById("fichas-list");
        const ingredientesContainer = document.getElementById("ingredientes-container");
        const addIngredienteBtn = document.getElementById("add-ingrediente-btn");
        const ingredientesOptions = document.getElementById("ingredientes-options");
        const fcForm = document.getElementById("fc-form");
        const fcIngrediente = document.getElementById("fc-ingrediente");
        const fcFator = document.getElementById("fc-fator");
        const fcPreco = document.getElementById("fc-preco");
        const fcUnidade = document.getElementById("fc-unidade");
        const fcListDiv = document.getElementById("fc-list");
        const custoTotalPratoSpan = document.getElementById("custo-total-prato");
        const custoPorPorcaoSpan = document.getElementById("custo-por-porcao");
        const precoSugeridoSpan = document.getElementById("preco-sugerido");
        const precoRealInput = document.getElementById("preco-real");
        const adminView = document.getElementById("admin-view");
        const adminLinkEl = document.getElementById("admin-link");
        const voltarMainBtn = document.getElementById("voltar-main");
        const superadminSection = document.getElementById("superadmin-section");
        const adminSection = document.getElementById("admin-section");
        const addCompanyForm = document.getElementById("add-company-form");
        const empresasListDiv = document.getElementById("empresas-list");
        const addUserForm = document.getElementById("add-user-form");
        const usuariosListDiv = document.getElementById("usuarios-list");
        const importFileInput = document.getElementById("import-file");
        const cmvRealDisplay = document.getElementById("cmv-real-display");
        const margemLucroDisplay = document.getElementById("margem-lucro-display");
        const currentCmvDisplay = document.getElementById("current-cmv-display");
        const cmvForm = document.getElementById("cmv-form");
        const cmvManualContainer = document.getElementById("cmv-manual-container");
        const cmvManualInput = document.getElementById("cmv-manual-input");
        const calcularCmvBtn = document.getElementById("calcular-cmv-btn");
        const importarCmvBtn = document.getElementById("importar-cmv-btn");
        const mostrarManualBtn = document.getElementById("mostrar-manual-btn");
        const cmvResultsDiv = document.getElementById("cmv-results");
        const balanceTableContainer = document.getElementById("balance-table-container");
        const balanceSummaryBtn = document.getElementById("balance-summary-btn");
        const applyBalanceBtn = document.getElementById("apply-balance-btn");
        const balanceSummaryDiv = document.getElementById("balance-summary");
        const balanceSummaryModal = document.getElementById("balance-summary-modal");
        const balancePdfBtn = document.getElementById("balance-pdf-btn");
        const balanceSupplierFilter = document.getElementById("balance-supplier-filter");
        const balanceNewView = document.getElementById("balance-new-view");
        const balanceHistoryView = document.getElementById("balance-history-view");
        const historyDateFilter = document.getElementById("history-date-filter");
        const historyTypeFilter = document.getElementById("history-type-filter");
        const historyListDiv = document.getElementById("balance-history-list");
        const historyModal = document.getElementById("history-modal");

        // Helper Functions
        function colEmp(...segs){ return collection(db, ...companyPath, ...segs); }
        function docEmp(...segs){ return doc(db, ...companyPath, ...segs); }
        async function loadCompanyByEmail(email){
            companyPath = [];
            const q = query(collectionGroup(db, "usuarios"), where("email", "==", email));
            try {
                const snap = await getDocs(q);
                if(!snap.empty){
                    const docSnap = snap.docs[0];
                    const ref = docSnap.ref.parent.parent;
                    companyPath = ["empresas", ref.id];
                    return docSnap.data().role || 'usuario';
                }
            } catch (error) {
                console.error('Erro ao buscar empresa:', error.code, error.message);
                showMessage('Não foi possível carregar os dados da empresa.', true);
            }
            return null;
        }
        function showMessage(msg, isError = false) {
            const msgDiv = document.createElement("div");
            msgDiv.textContent = msg;
            msgDiv.className = `p-3 rounded-lg shadow-md mb-2 ${isError ? 'bg-red-500 text-white' : 'bg-green-500 text-white'}`;
            messageContainer.prepend(msgDiv);
            setTimeout(() => msgDiv.remove(), 5000);
        }

        function toggleViews(activeViewId) {
            const views = [loginView, signupView, mainAppView, adminView];
            views.forEach(view => {
                if (view.id === activeViewId) {
                    view.classList.remove("hidden");
                } else {
                    view.classList.add("hidden");
                }
            });
        }

        function switchTab(tabName) {
            tabContents.forEach(tabContent => {
                if (tabContent.id === `tab-${tabName}`) {
                    tabContent.classList.add("active");
                } else {
                    tabContent.classList.remove("active");
                }
            });
            document.querySelectorAll(".tab-button").forEach(button => {
                if (button.dataset.tab === tabName) {
                    button.classList.add("active");
                } else {
                    button.classList.remove("active");
                }
            });
        }

        function escapeHtml(unsafe) {
            return unsafe
                .replace(/&/g, "&amp;")
                .replace(/</g, "&lt;")
                .replace(/>/g, "&gt;")
                .replace(/"/g, "&quot;")
                .replace(/'/g, "&#039;");
        }

        function formatDateBR(dateStr) {
            const [year, month, day] = dateStr.split('-');
            return `${day}/${month}/${year}`;
        }

        function formatDateISO(date){
            const [day, month, year] = new Date(date).toLocaleDateString('pt-BR').split('/');
            return `${year}-${month}-${day}`;
        }

        function formatDateFile(date){
            const [day, month, year] = new Date(date).toLocaleDateString('pt-BR').split('/');
            return `${day}-${month}-${year}`;
        }

        function formatDateTimeBR(date) {
            if (!date) return '—';
            const d = new Date(date);
            return d.toLocaleString('pt-BR', {
                day: '2-digit',
                month: '2-digit',
                year: 'numeric',
                hour: '2-digit',
                minute: '2-digit',
            });
        }

        function formatQty(value) {
            const num = parseFloat(value);
            if (isNaN(num)) return '0';
            return parseFloat(num.toFixed(3)).toString();
        }
        function updateDashboard() {
            if (!dashboardView) return;
            dashboardTotalStock.textContent = appState.stockItems.length.toString();
            const missing = appState.stockItems.filter(it => (it.minimo || 0) > 0 && (it.quantidadeAtual || 0) < (it.minimo || 0)).length;
            dashboardItemsMissing.textContent = missing.toString();
            const todayISO = formatDateISO(new Date());
            const prodToday = appState.productionItems.filter(it => {
                const t = it.timestamp && it.timestamp.seconds ? new Date(it.timestamp.seconds * 1000) : new Date(it.timestamp);
                return formatDateISO(t) === todayISO;
            }).length;
            dashboardDailyProduction.textContent = prodToday.toString();
        }

        function getStockItemByName(name) {
            return appState.stockItems.find(it => (it.item || '') === name) || null;
        }

       function getFCData(name) {
           return appState.fcValues[name] || null;
       }

        function checkBalanceInputs() {
             const inputs = document.querySelectorAll('.contagem-input');
             const anyFilled = Array.from(inputs).some(inp => inp.value.trim() !== '');
             if(balanceSummaryBtn) balanceSummaryBtn.disabled = !anyFilled;
             if(applyBalanceBtn) applyBalanceBtn.disabled = !anyFilled;
             if(balancePdfBtn) balancePdfBtn.disabled = !anyFilled;
             return anyFilled;
        }

       async function saveShoppingListToFirestore() {
            const user = auth.currentUser;
            if (!user) return;
            const slFilter = document.getElementById('shopping-list-supplier-filter');
            const fornecedorSel = slFilter ? slFilter.value : 'TODOS';
            const items = Array.from(document.querySelectorAll('.shopping-list-item')).map(div => {
                const qty = parseFloat(div.querySelector('.shopping-quantity-input').value) || 0;
                return {
                    nome: div.dataset.itemName || '',
                    unidade: div.dataset.itemUnit || '',
                    quantidade: qty,
                    fornecedor: div.dataset.supplier || '',
                    criadoEm: new Date().toISOString()
                };
            });
            const dateKey = new Date().toLocaleDateString('pt-BR').replace(/\//g,'-');
            await setDoc(docEmp('listaCompras', user.uid, 'dias', dateKey), {
                fornecedor: fornecedorSel,
                itens: items
            });
            cleanupOldShoppingLists();
       }

       async function loadShoppingListFromFirestore(filterElem, itemsContainer, renderFn){
            const user = auth.currentUser;
            if(!user) return;
            const dateKey = new Date().toLocaleDateString('pt-BR').replace(/\//g,'-');
            const snap = await getDoc(docEmp('listaCompras', user.uid, 'dias', dateKey));
            if(!snap.exists()) return;
            if(!confirm('Você tem uma lista de compras salva hoje. Deseja continuar de onde parou?')) return;
            const data = snap.data();
            if(data.fornecedor && filterElem) filterElem.value = data.fornecedor;
            renderFn();
            if(Array.isArray(data.itens)){
                data.itens.forEach(it => {
                    const div = Array.from(itemsContainer.querySelectorAll('.shopping-list-item')).find(d => d.dataset.itemName === it.nome && d.dataset.supplier === (it.fornecedor||d.dataset.supplier));
                    if(div){
                        div.querySelector('.shopping-quantity-input').value = it.quantidade;
                    } else {
                        const extra = document.createElement('div');
                        extra.className = 'flex items-center justify-between bg-gray-50 p-2 rounded-lg shadow-sm shopping-list-item';
                        extra.dataset.supplier = it.fornecedor || '';
                        extra.dataset.itemName = it.nome;
                        extra.dataset.currentQty = '';
                        extra.dataset.itemUnit = it.unidade || '';
                        extra.innerHTML = `
                            <p class="font-semibold text-gray-800 w-1/3">${escapeHtml(it.nome || '')}</p>
                            <p class="text-sm text-gray-600 w-1/4"></p>
                            <input type="number" class="w-1/4 p-1 border rounded text-center text-sm shopping-quantity-input" step="any" value="${it.quantidade}">
                            <button class="delete-shopping-item bg-red-500 hover:bg-red-700 text-white text-xs font-bold py-1 px-2 rounded">Excluir</button>`;
                        itemsContainer.appendChild(extra);
                    }
                });
            }
       }

       async function cleanupOldShoppingLists(){
            const user = auth.currentUser;
            if(!user) return;
            if (!companyPath.length) {
                console.warn("Nenhuma empresa associada; limpeza de listas de compras não executada.");
                return;
            }
            const colRef = colEmp('listaCompras', user.uid, 'dias');
            const snap = await getDocs(colRef);
            const today = new Date();
            snap.forEach(d => {
                const [day,month,year] = d.id.split('-');
                const docDate = new Date(`${year}-${month}-${day}`);
                const diffDays = (today - docDate) / 86400000;
                if(diffDays > 2){
                    deleteDoc(docEmp('listaCompras', user.uid, 'dias', d.id));
                }
            });
       }

       function debounce(func, wait){
            let timeout;
            return function(...args){
                clearTimeout(timeout);
                timeout = setTimeout(()=>func.apply(this,args), wait);
            };
       }

       async function saveTempBalanceToFirestore(){
            const user = auth.currentUser;
            if(!user) return;
            const tipo = appState.currentBalanceGroup;
            const rows = Array.from(document.querySelectorAll('.balance-row'));
            const itens = rows.map(r => ({
                nome: r.dataset.name || '',
                unidade: r.dataset.unit || '',
                estoqueAtual: parseFloat(r.dataset.current || '0'),
                contagemReal: parseFloat(r.querySelector('.contagem-input').value) || 0,
                justificativa: r.dataset.justificativa || ''
            }));
            const dateKey = new Date().toLocaleDateString('pt-BR').replace(/\//g,'-');
           await setDoc(docEmp('balanco_temp', user.email, tipo, dateKey), {
                criadoEm: new Date().toISOString(),
                itens
            });
            cleanupOldTempBalances();
       }

       const debouncedSaveBalanceTemp = debounce(saveTempBalanceToFirestore, 800);

       async function loadTempBalanceFromFirestore(tipo = appState.currentBalanceGroup){
            const user = auth.currentUser;
            if(!user) return;
            if(appState.tempBalancePrompted) return;
            const dateKey = new Date().toLocaleDateString('pt-BR').replace(/\//g,'-');
            const snap = await getDoc(docEmp('balanco_temp', user.email, tipo, dateKey));
            if(!snap.exists()) return;
            appState.tempBalancePrompted = true;
            if(!confirm('Você tem um balanço em andamento para hoje. Deseja continuar de onde parou?')){
               await deleteDoc(docEmp('balanco_temp', user.email, tipo, dateKey));
               appState.tempBalancePrompted = false;
               return;
            }
            const data = snap.data();
            const rows = Array.from(document.querySelectorAll('.balance-row'));
            rows.forEach(r => {
                const item = (data.itens||[]).find(it => it.nome === r.dataset.name && (it.unidade||'') === (r.dataset.unit||''));
                if(item){
                    const input = r.querySelector('.contagem-input');
                    input.value = item.contagemReal;
                    r.dataset.justificativa = item.justificativa || '';
                }
            });
            checkBalanceInputs();
       }

       async function cleanupOldTempBalances(){
            const user = auth.currentUser;
            if(!user) return;
            if (!companyPath.length) {
                console.warn("Nenhuma empresa associada; limpeza de balanços temporários não executada.");
                return;
            }
            const types = ['fornecedor','cozinha','parrilla'];
            const today = new Date();
            for(const t of types){
                const colRef = colEmp('balanco_temp', user.email, t);
                const snap = await getDocs(colRef);
                snap.forEach(d => {
                    const [day,month,year] = d.id.split('-');
                    const docDate = new Date(`${year}-${month}-${day}`);
                    const diffDays = (today - docDate) / 86400000;
                    if(diffDays > 2){
                        deleteDoc(docEmp('balanco_temp', user.email, t, d.id));
                    }
                });
            }
       }

        async function loadCompanies(){
            try {
                const snap = await getDocs(collection(db, 'empresas'));
                empresasListDiv.innerHTML = '';
                snap.forEach(d => {
                    const div = document.createElement('div');
                    const data = d.data();
                    div.textContent = `${d.id} - ${data.razao || ''}`;
                    empresasListDiv.appendChild(div);
                });
            } catch (error) {
                console.error('Erro ao carregar empresas:', error.code, error.message);
                showMessage('Não foi possível carregar as empresas.', true);
            }
        }

       async function loadUsers(){
            if (!companyPath.length) {
                console.warn("Nenhuma empresa associada; usuários não carregados.");
                return;
            }
            const colRef = colEmp('usuarios');
            const snap = await getDocs(colRef);
            usuariosListDiv.innerHTML = '';
            snap.forEach(d => {
                const div = document.createElement('div');
                div.innerHTML = `${d.data().email} <button data-uid="${d.id}" class="delete-user text-red-500 text-xs">Excluir</button>`;
                usuariosListDiv.appendChild(div);
            });
        }

        async function importStockFile(file){
            let rows = [];
            const ext = file.name.split('.').pop().toLowerCase();
            if(ext === 'csv'){
                const text = await file.text();
                rows = Papa.parse(text, {header:true}).data;
            }else{
                const data = await file.arrayBuffer();
                const wb = XLSX.read(data, {type:'array'});
                rows = XLSX.utils.sheet_to_json(wb.Sheets[wb.SheetNames[0]]);
            }
            for(const r of rows){
                if(!r.item && !r.Item) continue;
                await addDoc(colEmp('estoque'), {
                    item: r.item || r.Item || '',
                    fornecedor: r.fornecedor || r.Fornecedor || '',
                    quantidadeAtual: parseFloat(r.quantidadeAtual || r.Quantidade || 0),
                    unidade: r.unidade || r.Unidade || '',
                    preco: parseFloat(r.preco || r.Preco || 0),
                    minimo: parseFloat(r.minimo || r.Minimo || 0),
                    ideal: parseFloat(r.ideal || r.Ideal || 0),
                    historicoEntradas: [],
                    ultimaAtualizacao: new Date().toISOString(),
                    timestamp: new Date().toISOString()
                });
            }
            showMessage('Importação concluída');
        }

        function addIngredienteRow(data = {}) {
            const row = document.createElement('div');
            row.className = 'grid grid-cols-4 sm:grid-cols-8 gap-2 items-center text-sm';

            const select = document.createElement('input');
            select.setAttribute('list', 'ingredientes-options');
            select.placeholder = 'Ingrediente';
            select.className = 'ingrediente-nome border rounded p-1';
            select.value = data.nome || '';

            const qtyInput = document.createElement('input');
            qtyInput.type = 'number';
            qtyInput.step = 'any';
            qtyInput.className = 'q-liquida border rounded p-1 text-sm';
            qtyInput.value = data.qtdLiquida || '';

            const unidadeInput = document.createElement('input');
            unidadeInput.type = 'text';
            unidadeInput.className = 'unidade border rounded p-1';
            unidadeInput.readOnly = true;
            unidadeInput.value = data.unidade || '';

            const fcInput = document.createElement('input');
            fcInput.type = 'number';
            fcInput.step = 'any';
            fcInput.className = 'fator border rounded p-1';
            fcInput.readOnly = true;
            fcInput.value = data.fc || '';

            const qBrutaSpan = document.createElement('span');
            qBrutaSpan.className = 'q-bruta';
            qBrutaSpan.textContent = '0';

            const custoUnitSpan = document.createElement('span');
            custoUnitSpan.className = 'custo-unit';
            custoUnitSpan.textContent = '0';

            const custoTotalSpan = document.createElement('span');
            custoTotalSpan.className = 'custo-total';
            custoTotalSpan.textContent = '0';

            const removeBtn = document.createElement('button');
            removeBtn.type = 'button';
            removeBtn.textContent = 'Excluir';
            removeBtn.className = 'bg-red-500 hover:bg-red-700 text-white text-xs font-bold py-1 px-2 rounded';

            removeBtn.addEventListener('click', () => {
                row.remove();
                calculateFichaTotals();
            });

            function updateRow() {
                const itemName = select.value;
                const qty = parseFloat(qtyInput.value) || 0;
                const fcData = getFCData(itemName);
                const fc = fcData ? fcData.fator : 1;
                fcInput.value = fc;
                const qBruta = qty * fc;
                qBrutaSpan.textContent = formatQty(qBruta);

                const stock = getStockItemByName(itemName);
                const unidade = fcData ? fcData.unidade : (stock ? stock.unidade : '');
                unidadeInput.value = unidade || '';
                const custoUnit = fcData ? fcData.preco : (stock && stock.preco ? parseFloat(stock.preco) : 0);
                custoUnitSpan.textContent = custoUnit.toFixed(2);
                const custoTotal = qBruta * custoUnit;
                custoTotalSpan.textContent = custoTotal.toFixed(2);

                calculateFichaTotals();
            }

            select.addEventListener('change', updateRow);
            qtyInput.addEventListener('input', updateRow);
            fcInput.addEventListener('input', updateRow);

            row.appendChild(select);
            row.appendChild(qtyInput);
            row.appendChild(unidadeInput);
            row.appendChild(fcInput);
            row.appendChild(qBrutaSpan);
            row.appendChild(custoUnitSpan);
            row.appendChild(custoTotalSpan);
            row.appendChild(removeBtn);

            ingredientesContainer.appendChild(row);
            updateRow();
        }

        function calculateFichaTotals() {
            let total = 0;
            ingredientesContainer.querySelectorAll('.custo-total').forEach(span => {
                total += parseFloat(span.textContent) || 0;
            });
            custoTotalPratoSpan.textContent = total.toFixed(2);

            const rendimento = parseFloat(document.getElementById('ficha-rendimento').value) || 1;
            const porcao = rendimento > 0 ? total / rendimento : 0;
            custoPorPorcaoSpan.textContent = porcao.toFixed(2);

            const cmv = appState.currentCMV;
            const precoSugerido = cmv > 0 ? porcao / (cmv / 100) : 0;
            precoSugeridoSpan.textContent = precoSugerido.toFixed(2);

            const precoReal = parseFloat(precoRealInput.value) || 0;
            const cmvReal = precoReal > 0 ? (porcao / precoReal) * 100 : 0;
            const margem = precoReal > 0 ? ((precoReal - porcao) / precoReal) * 100 : 0;
            cmvRealDisplay.textContent = cmvReal.toFixed(2) + '%';
            margemLucroDisplay.textContent = margem.toFixed(2) + '%';
        }

        // Render Functions
        function renderStockList() {
            stockListDiv.innerHTML = "";
            const filteredItems = appState.stockItems
                .filter(item => appState.currentSupplierFilter === 'TODOS' || item.fornecedor === appState.currentSupplierFilter)
                .sort((a, b) => (a.item || '').localeCompare(b.item || ''));

            if (filteredItems.length === 0) {
                stockListDiv.innerHTML = "<p class=\"text-gray-500\">Nenhum item no estoque para este fornecedor.</p>";
                return;
            }

            const groupedBySupplier = {};
            filteredItems.forEach(item => {
                if (!groupedBySupplier[item.fornecedor]) {
                    groupedBySupplier[item.fornecedor] = [];
                }
                groupedBySupplier[item.fornecedor].push(item);
            });

            Object.keys(groupedBySupplier).sort().forEach(supplier => {
                const supplierHeader = document.createElement('h3');
                supplierHeader.className = 'text-md font-medium text-gray-700 mt-4 mb-2';
                supplierHeader.textContent = `Fornecedor: ${supplier}`;
                stockListDiv.appendChild(supplierHeader);

                const table = document.createElement('table');
                table.className = 'w-full text-sm mb-4';
                table.innerHTML = `
                    <thead class="bg-gray-200">
                        <tr>
                            <th class="p-2 text-left">Item</th>
                            <th class="p-2 text-center">Quantidade Atual</th>
                            <th class="p-2 text-center">Nova Entrada</th>
                            <th class="p-2 text-center">Total Atualizado</th>
                            <th class="p-2 text-center">Última Atualização</th>
                            <th class="p-2 text-center">Ações</th>
                        </tr>
                    </thead>
                    <tbody></tbody>
                `;
                const tbody = table.querySelector('tbody');

                groupedBySupplier[supplier].forEach(item => {
                    const row = document.createElement('tr');
                    row.innerHTML = `
                        <td class="p-2 font-semibold">${escapeHtml(item.item || '')}</td>
                        <td class="p-2 text-center">${formatQty(item.quantidadeAtual || 0)} ${escapeHtml(item.unidade || '')}</td>
                        <td class="p-2 text-center"><input type="number" data-item-id="${item.id}" data-update-type="entrada" data-current="${item.quantidadeAtual}" step="any" class="w-24 p-1 border rounded text-center text-sm entrada-input"></td>
                        <td class="p-2 text-center total-atualizado"></td>
                        <td class="p-2 text-center">${formatDateTimeBR(item.ultimaAtualizacao)}</td>
                        <td class="p-2 text-center">
                              <button onclick="saveEntrada('${item.id}')" class="btn btn-primary btn-xs">Salvar</button>
                              <button onclick="deleteStockItem('${item.id}')" class="btn btn-error btn-xs ml-1">Excluir</button>
                        </td>`;
                    tbody.appendChild(row);

                    const input = row.querySelector('input');
                    input.addEventListener('input', () => handleEntradaInput(input));
                });

                stockListDiv.appendChild(table);
            });
        }

function renderProductionList() {
            productionListDiv.innerHTML = "";
            const filteredItems = appState.productionItems.filter(item =>
                appState.currentSectorFilter === 'TODOS' || item.setor === appState.currentSectorFilter
            );
            if (filteredItems.length === 0) {
                productionListDiv.innerHTML = "<p class=\"text-gray-500\">Nenhum item na produção para este setor.</p>";
                return;
            }
            const table = document.createElement('table');
            table.className = 'min-w-full divide-y divide-gray-200 text-sm';
            table.innerHTML = `<thead class="bg-gray-50">
                <tr>
                    <th class="p-2 text-left">Item</th>
                    <th class="p-2 text-center">Qtd. Atual</th>
                    <th class="p-2 text-center">Produzido Agora</th>
                    <th class="p-2 text-center">Total</th>
                    <th class="p-2 text-center">Última Atualização</th>
                    <th class="p-2 text-center">Ações</th>
                </tr>
            </thead><tbody></tbody>`;
            const tbody = table.querySelector('tbody');
            filteredItems.forEach(item => {
                const last = item.timestamp ? formatDateTimeBR(item.timestamp.seconds ? item.timestamp.seconds*1000 : item.timestamp) : '—';
                const tr = document.createElement('tr');
                tr.innerHTML = `
                    <td class="p-2 font-semibold">${escapeHtml(item.item || '')}</td>
                    <td class="p-2 text-center">${formatQty(item.quantidade || 0)}</td>
                    <td class="p-2 text-center"><input type="number" data-item-id="${item.id}" step="any" class="nova-producao-input w-24 p-1 border rounded text-center text-sm"></td>
                    <td class="p-2 text-center" id="total-${item.id}">${formatQty(item.quantidade || 0)}</td>
                    <td class="p-2 text-center">${last}</td>
                    <td class="p-2 text-center">
                          <button onclick="updateProductionItem('${item.id}')" class="btn-salvar btn btn-primary btn-xs">Salvar</button>
                          <button onclick="deleteProductionItem('${item.id}')" class="btn-excluir btn btn-error btn-xs ml-1">Excluir</button>
                    </td>`;
                const input = tr.querySelector('input');
                input.addEventListener('input', () => {
                    const val = parseFloat(input.value) || 0;
                    document.getElementById('total-' + item.id).textContent = formatQty(Number(item.quantidade || 0) + val);
                });
                tbody.appendChild(tr);
            });
            productionListDiv.appendChild(table);
        }
        function renderObservationList(sector) {
            const listDiv = sector === 'parrilla' ? parrillaObsListDiv : cozinhaObsListDiv;
            const obsArray = sector === 'parrilla' ? appState.obsParrilla : appState.obsCozinha;
            listDiv.innerHTML = '';
            if (obsArray.length === 0) {
                listDiv.innerHTML = '<p class="text-gray-500">Nenhuma observação cadastrada.</p>';
                return;
            }
            const sorted = [...obsArray].sort((a, b) => a.id.localeCompare(b.id));
            sorted.forEach(obs => {
                const div = document.createElement('div');
                div.className = 'bg-gray-50 p-3 rounded-lg shadow-sm flex justify-between';
                div.innerHTML = `
                    <div class="mr-2">
                        <p class="font-semibold text-gray-800">${formatDateBR(obs.id)}</p>
                        <p class="text-sm text-gray-600 break-normal whitespace-pre-line">${escapeHtml(obs.texto || '')}</p>
                    </div>
                      <div class="flex flex-col space-y-1">\
                          <button onclick="editObservation('${sector}','${obs.id}')" class="btn btn-primary btn-xs">Editar</button>\
                          <button onclick="deleteObservation('${sector}','${obs.id}')" class="btn btn-error btn-xs">Excluir</button>\
                    </div>`;
                listDiv.appendChild(div);
            });
        }

        function renderSuppliersList() {
            suppliersListDiv.innerHTML = "";
            if (appState.suppliers.length === 0) {
                suppliersListDiv.innerHTML = "<p class=\"text-gray-500\">Nenhum fornecedor cadastrado.</p>";
                return;
            }
            appState.suppliers.forEach(supplier => {
                const nome = supplier.nome || supplier.name || "";
                const supplierDiv = document.createElement("div");
                supplierDiv.className = "bg-gray-50 p-2 rounded-lg shadow-sm flex items-center justify-between";
                supplierDiv.innerHTML = `
                    <p class="font-semibold text-gray-800">${escapeHtml(nome)}</p>
                    <button onclick="deleteSupplier('${supplier.id}')" class="bg-red-500 hover:bg-red-700 text-white text-xs font-bold py-1 px-2 rounded">Excluir</button>
                `;
                suppliersListDiv.appendChild(supplierDiv);
            });
        }

       function updateSupplierFilter() {
           supplierFilter.innerHTML = `<option value="TODOS">TODOS</option>`;
           appState.suppliers.forEach(supplier => {
               const nome = supplier.nome || supplier.name || "";
               const option = document.createElement("option");
               option.value = nome;
               option.textContent = nome;
               supplierFilter.appendChild(option);
           });
           supplierFilter.size = 1;
       }

       function updateBalanceSupplierFilter(){
           if(!balanceSupplierFilter) return;
           balanceSupplierFilter.innerHTML = `<option value="TODOS">TODOS</option>`;
           appState.suppliers.forEach(supplier => {
               const nome = supplier.nome || supplier.name || "";
               const opt = document.createElement('option');
               opt.value = nome;
               opt.textContent = nome;
               balanceSupplierFilter.appendChild(opt);
           });
           balanceSupplierFilter.size = 1;
       }

       function renderSupplierSelect() {
           const productSupplierSelect = document.getElementById('product-supplier');
           if (!productSupplierSelect) return;

           const sortedSuppliers = [...appState.suppliers].sort((a, b) => (a.nome || a.name || '').localeCompare(b.nome || b.name || ''));

           productSupplierSelect.innerHTML = `
               <option value="">Selecione um fornecedor</option>
               ${sortedSuppliers.map(supplier => {
                   const nome = supplier.nome || supplier.name || "";
                   return `<option value="${escapeHtml(nome)}">${escapeHtml(nome)}</option>`;
               }).join('')}
           `;
           productSupplierSelect.size = 1;
       }

       function updateShoppingListSupplierFilter() {
           const slFilter = document.getElementById('shopping-list-supplier-filter');
           if (!slFilter) return;

           slFilter.innerHTML = `
                <option value="TODOS">Todos os fornecedores</option>
                ${appState.suppliers
                    .map(s => {
                        const label = escapeHtml(s.nome || s.name || '');
                        return `<option value="${label}">${label}</option>`;
                    })
                    .join('')}
           `;
           slFilter.size = 1;
       }

       function updateEtiquetaProdutoSelect() {
           const select = document.getElementById('etiqueta-produto-select');
           if (!select) return;
           if (!companyPath.length) {
               console.warn("Nenhuma empresa associada; etiqueta de produto não atualizada.");
               return;
           }
           const today = formatDateISO(new Date()).split(',')[0];
           const todays = appState.productionItems.filter(it => {
               const d = it.timestamp && it.timestamp.seconds ? formatDateISO(new Date(it.timestamp.seconds * 1000)).split(',')[0] : formatDateISO(new Date(it.timestamp)).split(',')[0];
               return d === today;
           });
           const names = [...new Set(todays.map(it => it.item))].sort();
           if (names.length === 0) {
               select.innerHTML = '<option value="" disabled>Nenhum item lançado hoje na produção.</option>';
           } else {
               select.innerHTML = names.map(n => `<option value="${escapeHtml(n)}">${escapeHtml(n)}</option>`).join('');
           }
           select.innerHTML += '<option value="CUSTOM">+ Digitar item personalizado</option>';
           select.size = 1;
       }

       function renderFichasList() {
           if (!fichasListDiv) return;
           fichasListDiv.innerHTML = '';
           if (appState.fichasTecnicas.length === 0) {
               fichasListDiv.innerHTML = '<p class="text-gray-500">Nenhuma ficha cadastrada.</p>';
               return;
           }
           const sorted = [...appState.fichasTecnicas].sort((a,b)=> (a.nome||'').localeCompare(b.nome||''));
           sorted.forEach(f => {
               const preco = f.precoSugerido || 0;
               const div = document.createElement('div');
               div.className = 'bg-gray-50 p-3 rounded-lg shadow-sm flex items-center justify-between';
               div.innerHTML = `
                   <div>
                       <p class="font-semibold text-gray-800">${escapeHtml(f.nome || '')}</p>
                       <p class="text-sm text-gray-600">Categoria: ${escapeHtml(f.categoria || '')}</p>
                       <p class="text-sm text-gray-600">Preço sugerido: R$ ${preco.toFixed(2)}</p>
                   </div>
                   <div class="flex items-center space-x-2">
                       <button onclick="generateFichaPdf('${f.id}')" class="bg-gray-500 hover:bg-gray-700 text-white text-xs font-bold py-1 px-2 rounded">PDF</button>
                       <button onclick="deleteFicha('${f.id}')" class="bg-red-500 hover:bg-red-700 text-white text-xs font-bold py-1 px-2 rounded">Excluir</button>
                   </div>
               `;
               fichasListDiv.appendChild(div);
           });
       }

       function updateIngredienteOptions() {
           if (!ingredientesOptions) return;
           ingredientesOptions.innerHTML = Object.keys(appState.fcValues)
               .sort()
               .map(n => `<option value="${escapeHtml(n)}">`)
               .join('');
       }

       function renderFcList() {
           if (!fcListDiv) return;
           fcListDiv.innerHTML = '';
           const names = Object.keys(appState.fcValues).sort();
           if (names.length === 0) {
               fcListDiv.innerHTML = '<p class="text-gray-500">Nenhum ingrediente cadastrado.</p>';
               return;
           }
           names.forEach(name => {
               const d = appState.fcValues[name];
               const div = document.createElement('div');
               div.className = 'bg-gray-50 p-2 rounded flex justify-between items-center';
               div.innerHTML = `<span>${escapeHtml(name)} - FC: ${d.fator} - Preço: R$ ${Number(d.preco||0).toFixed(2)}</span>` +
                   `<button data-name="${escapeHtml(name)}" class="delete-fc text-xs bg-red-500 hover:bg-red-700 text-white px-2 py-1 rounded">Excluir</button>`;
               fcListDiv.appendChild(div);
           });
       }

       function renderFcIngredienteSelect() {
           if (!fcIngrediente) return;
           fcIngrediente.innerHTML = '<option value="">Selecione</option>' +
               appState.stockItems
                   .sort((a,b)=> (a.item||'').localeCompare(b.item||''))
                   .map(it => `<option value="${escapeHtml(it.item)}">${escapeHtml(it.item)}</option>`)
                   .join('');
       }

       function renderBalanceTable(tipo = appState.currentBalanceGroup) {
           appState.currentBalanceGroup = tipo;
           if(!balanceTableContainer) return;
           balanceTableContainer.innerHTML = '';
           if(balanceSupplierFilter){
               balanceSupplierFilter.classList.toggle('hidden', tipo !== 'fornecedor');
           }
           let items = [];
           if (tipo === 'fornecedor') {
               items = appState.stockItems.map(it => ({
                   id: it.id,
                   nome: it.item,
                   unidade: it.unidade,
                   quantidade: it.quantidadeAtual,
                   fornecedor: it.fornecedor,
                   tipo: 'fornecedor'
               }));
               if(appState.currentBalanceSupplierFilter !== 'TODOS'){
                   items = items.filter(it => (it.fornecedor || '') === appState.currentBalanceSupplierFilter);
               }
           } else {
               const sector = tipo === 'cozinha' ? 'COZINHA' : 'PARRILLA';
               items = appState.productionItems
                   .filter(it => it.setor === sector)
                   .map(it => ({
                       id: it.id,
                       nome: it.item,
                       unidade: it.unidade,
                       quantidade: it.quantidade,
                       tipo
                   }));
           }
           if(items.length === 0){
               balanceTableContainer.innerHTML = '<p class="text-gray-500">Nenhum item encontrado.</p>';
               return;
           }
           const table = document.createElement('table');
           table.className = 'balanco-table w-full table-auto text-sm divide-y divide-gray-200';
           table.innerHTML = `<thead class="bg-gray-50"><tr>
                   <th class="table-col text-left">Item</th>
                   <th class="table-col text-left">Unidade</th>
                   <th class="table-col text-right">Estoque Atual</th>
                   <th class="table-col text-right">Contagem Real</th>
               </tr></thead><tbody></tbody>`;
           const tbody = table.querySelector('tbody');
           items.sort((a,b)=>a.nome.localeCompare(b.nome)).forEach(it => {
               const tr = document.createElement('tr');
               tr.className = 'balance-row';
               tr.dataset.id = it.id;
               tr.dataset.tipo = it.tipo;
               tr.dataset.name = it.nome;
               if(it.fornecedor) tr.dataset.supplier = it.fornecedor;
               tr.dataset.unit = it.unidade || '';
               tr.dataset.current = it.quantidade || 0;
               tr.dataset.justificativa = '';
               tr.innerHTML = `
                   <td class="table-col">${escapeHtml(it.nome || '')}</td>
                   <td class="table-col">${escapeHtml(it.unidade || '')}</td>
                   <td class="table-col text-right">${formatQty(it.quantidade || 0)}</td>
                   <td class="table-col text-right"><input type="number" step="any" class="contagem-input w-16 p-1 border rounded text-center"></td>`;
               const input = tr.querySelector('.contagem-input');
               function handleInput(){
                   checkBalanceInputs();
                   debouncedSaveBalanceTemp();
               }
               input.addEventListener('input', handleInput);
               tbody.appendChild(tr);
           });
           const wrapper = document.createElement('div');
           wrapper.className = 'balanco-scroll';
           const responsive = document.createElement('div');
           responsive.className = 'balanco-tabela-container';
           responsive.appendChild(table);
           wrapper.appendChild(responsive);
           balanceTableContainer.appendChild(wrapper);
           checkBalanceInputs();
           loadTempBalanceFromFirestore(tipo);
       }

       function calcularCMV() {
           const ei = parseFloat(document.getElementById('cmv-estoque-inicial').value) || 0;
           const compras = parseFloat(document.getElementById('cmv-compras').value) || 0;
           const ef = parseFloat(document.getElementById('cmv-estoque-final').value) || 0;
           const despesas = parseFloat(document.getElementById('cmv-despesas-fixas').value) || 0;
           const mao = parseFloat(document.getElementById('cmv-mao-obra').value) || 0;
           const receita = parseFloat(document.getElementById('cmv-receita-bruta').value) || 0;
           const cmvCalc = (ei + compras) - ef;
           const cmvPerc = receita > 0 ? (cmvCalc / receita) * 100 : 0;
           cmvResultsDiv.innerHTML = `
               <p>Gasto Operacional Total: R$ ${(despesas + mao).toFixed(2)}</p>
               <p>CMV Absoluto: R$ ${cmvCalc.toFixed(2)}</p>
               <p>CMV (%): ${cmvPerc.toFixed(2)}%</p>
           `;
           return { ei, compras, ef, despesas, mao, receita, cmvCalc, cmvPerc };
       }

       // Função para escutar mudanças nos dados do Firebase
       function listenToDataChanges() {
            if (!companyPath.length) {
                console.warn("Nenhuma empresa associada; listener não iniciado.");
                return;
            }
            const stockCollectionRef = colEmp("estoque");
            appState.unsubscribeStock = onSnapshot(stockCollectionRef, (snapshot) => {
                appState.stockItems = snapshot.docs.map(doc => {
                    const d = doc.data();
                    return {
                        id: doc.id,
                        ...d,
                        quantidadeAtual: d.quantidadeAtual ?? d.atual ?? 0,
                        historicoEntradas: d.historicoEntradas || [],
                        ultimaAtualizacao: d.ultimaAtualizacao || d.timestamp
                    };
                });
                updateSupplierFilter();
                renderStockList();
                renderFcIngredienteSelect();
                renderBalanceTable();
                updateDashboard();
            }, (error) => console.error("Erro ao carregar estoque:", error));

            const productionCollectionRef = colEmp('producao');
            appState.unsubscribeProduction = onSnapshot(productionCollectionRef, (snapshot) => {
                appState.productionItems = snapshot.docs.map(doc => ({ id: doc.id, ...doc.data() }));
                renderProductionList();
                updateEtiquetaProdutoSelect();
                renderBalanceTable();
                updateDashboard();
            }, (error) => console.error("Erro ao carregar produção:", error));

            const suppliersCollectionRef = colEmp('fornecedores');
                appState.unsubscribeSuppliers = onSnapshot(suppliersCollectionRef, (snapshot) => {
                    appState.suppliers = snapshot.docs.map(doc => {
                        const data = doc.data();
                        return { id: doc.id, nome: data.nome || data.name || "" };
                    });
                    appState.suppliersLoaded = true;
                    renderSuppliersList();
                    renderSupplierSelect(); // Garante que o select de fornecedores seja atualizado
                    updateSupplierFilter(); // Atualiza filtro de fornecedores na lista de estoque
                    updateBalanceSupplierFilter(); // Atualiza filtro na aba de balanço
                    updateShoppingListSupplierFilter(); // Atualiza filtro na lista de compras, se visível
                }, (error) => console.error("Erro ao carregar fornecedores:", error));

            const parrillaObsRef = colEmp('observacoesProducao','parrilla','dias');
            appState.unsubscribeObsParrilla = onSnapshot(parrillaObsRef, (snapshot) => {
                appState.obsParrilla = snapshot.docs.map(d => ({ id: d.id, ...d.data() }));
                renderObservationList('parrilla');
            }, (error) => console.error('Erro ao carregar observações parrilla:', error));

            const cozinhaObsRef = colEmp('observacoesProducao','cozinha','dias');
            appState.unsubscribeObsCozinha = onSnapshot(cozinhaObsRef, (snapshot) => {
                appState.obsCozinha = snapshot.docs.map(d => ({ id: d.id, ...d.data() }));
                renderObservationList('cozinha');
            }, (error) => console.error('Erro ao carregar observações cozinha:', error));

            const fichasRef = colEmp('fichasTecnicas');
            appState.unsubscribeFichasTecnicas = onSnapshot(fichasRef, (snapshot) => {
                appState.fichasTecnicas = snapshot.docs.map(d => ({ id: d.id, ...d.data() }));
                renderFichasList();
            }, (error) => console.error('Erro ao carregar fichas:', error));

            const fcRef = colEmp('fc');
            appState.unsubscribeFC = onSnapshot(fcRef, (snapshot) => {
                appState.fcValues = {};
                snapshot.docs.forEach(d => {
                    appState.fcValues[d.id] = d.data();
                });
                renderFcList();
                updateIngredienteOptions();
            });

            const cmvRef = docEmp('config','cmvAplicado');
            appState.unsubscribeCMV = onSnapshot(cmvRef, (snap) => {
                if (snap.exists()) {
                    appState.currentCMV = snap.data().valor || 0;
                    if (currentCmvDisplay) currentCmvDisplay.textContent = appState.currentCMV.toFixed(2) + '%';
                    renderFichasList();
                }
            }, (error) => console.error('Erro ao carregar CMV aplicado:', error));
        }

        // PDF Generation Functions
         function generateStockReportBySupplier() {
             const incluirPrecos = confirm('Deseja incluir os preços de referência cadastrados nas fichas técnicas?');
             const { jsPDF } = window.jspdf;
             const doc = new jsPDF();
             const todayISO = formatDateISO(new Date());
             const dataBR = new Date().toLocaleDateString('pt-BR');
             const dateFile = formatDateFile(new Date());
             const horaBR = new Date().toLocaleTimeString('pt-BR');
             doc.setFont('helvetica');
             doc.setFontSize(11);
             doc.setTextColor(0,0,0);

            let valorTotalEstoque = 0;
            let finalYPosition = 0;

            const supplierGroups = {};
            appState.stockItems.forEach(item => {
                const supplier = item.fornecedor;
                if (!supplierGroups[supplier]) supplierGroups[supplier] = [];
                supplierGroups[supplier].push(item);
            });

            const sortedSuppliers = Object.keys(supplierGroups).sort();
            sortedSuppliers.forEach((supplier, supplierIndex) => {
                if (supplierIndex > 0) { doc.addPage(); }
                doc.setFontSize(16); doc.setFont(undefined,'bold');
                doc.text('Relatório de Estoque', 20, 20);
                doc.setFontSize(12); doc.text(`Fornecedor: ${supplier}`, 20, 30);
                doc.setFontSize(11); doc.setFont(undefined,'normal');
                doc.text(`Data: ${dataBR}`, 20, 40);
                doc.text(`Hora: ${horaBR}`, 20, 46);

                const items = supplierGroups[supplier].sort((a,b)=>a.item.localeCompare(b.item));
                let body = [];
                if(incluirPrecos){
                    body = items.map(it => {
                        const price = appState.fcValues[it.item]?.preco || 0;
                        const total = price * (it.quantidadeAtual || 0);
                        valorTotalEstoque += total;
                        return [
                            it.item,
                            formatQty(it.quantidadeAtual || 0),
                            '',
                            it.unidade,
                            `R$ ${price.toFixed(2)}`,
                            `R$ ${total.toFixed(2)}`
                        ];
                    });
                } else {
                    body = items.map(it => [
                        it.item,
                        formatQty(it.quantidadeAtual || 0),
                        it.unidade
                    ]);
                }

                const head = incluirPrecos ?
                    [['Item','Qtd. Atual','Qtd. Comprar','Unidade','Preço Ref.','Total']] :
                    [['Item','Quantidade Atual','Unidade']];
                const columnStyles = incluirPrecos ? {
                        0:{halign:'left'},
                        1:{halign:'center'},
                        2:{halign:'center'},
                        3:{halign:'center'},
                        4:{halign:'center'},
                        5:{halign:'center'}
                    } : {
                        0:{halign:'left', cellWidth:110},
                        1:{halign:'center', cellWidth:30},
                        2:{halign:'center', cellWidth:30}
                    };
                doc.autoTable({
                    head,
                    body,
                    startY: 60,
                    styles:{fontSize:11, lineHeight:1.1, cellPadding:4, noWrap:false, textColor:0},
                    headStyles:{fillColor:[217,217,217], textColor:0, fontStyle:'bold'},
                    bodyStyles:{fillColor:[255,255,255]},
                    alternateRowStyles:{fillColor:[242,242,242]},
                    columnStyles,
                    margin:{left:20,right:20}
                });
                finalYPosition = doc.lastAutoTable.finalY + 10;
            });

            if(incluirPrecos){
                doc.setFont(undefined,'bold');
                doc.text(`\uD83D\uDCE6 Valor Total em Estoque: R$ ${valorTotalEstoque.toFixed(2)}`, 20, finalYPosition);
            }

            doc.setFontSize(10);
            doc.text(`Gerado em ${dataBR}`, 20, 285);
            doc.text('App Estoque', 190, 285, {align:'right'});
            doc.save(`estoque-geral-${dateFile}.pdf`);
            showMessage('Relatório de estoque gerado com sucesso!');
        }

        function generateProductionReport(sector) {
            const { jsPDF } = window.jspdf;
            const doc = new jsPDF();
            const todayISO = formatDateISO(new Date());
            const dataBR = new Date().toLocaleDateString('pt-BR');
            const dateFile = formatDateFile(new Date());
            const horaBR = new Date().toLocaleTimeString('pt-BR');
            doc.setFont('helvetica');
            doc.setFontSize(11);
            doc.setTextColor(0,0,0);

            doc.setFontSize(16);
            doc.setFont(undefined, 'bold');
            doc.text(`Relatório de Produção - ${sector}`, 20, 20);
            doc.setFontSize(11);
            doc.setFont(undefined, 'normal');
            doc.text(`Data: ${dataBR}`, 20, 30);
            doc.text(`Hora: ${horaBR}`, 20, 36);

            let yPosition = 50;
            const filteredItems = appState.productionItems.filter(item => item.setor === sector);
            if (filteredItems.length === 0) {
                doc.text(`Nenhum item encontrado para o setor ${sector}.`, 20, yPosition);
            } else {
                const grouped = {};
                filteredItems.forEach(it => {
                    const d = it.timestamp && it.timestamp.seconds ? formatDateISO(new Date(it.timestamp.seconds * 1000)) : formatDateISO(new Date(it.timestamp));
                    if (!grouped[d]) grouped[d] = [];
                    grouped[d].push(it);
                });

                Object.keys(grouped).sort().forEach(date => {
                    if (yPosition > 250) { doc.addPage(); yPosition = 20; }
                    doc.setFont(undefined, 'bold');
                    doc.text(formatDateBR(date), 20, yPosition);
                    const body = grouped[date].sort((a,b)=>a.item.localeCompare(b.item)).map(it => [
                        it.item,
                        formatQty(it.quantidade || 0),
                        it.unidade,
                        it.observacao || ''
                    ]);
                    doc.autoTable({
                        head: [['Item produzido','Quantidade','Unidade','Observações']],
                        body,
                        startY: yPosition + 6,
                        styles:{fontSize:11, lineHeight:1.1, cellPadding:4, noWrap:false, textColor:0},
                        headStyles:{fillColor:[217,217,217], textColor:0, fontStyle:'bold'},
                        bodyStyles:{fillColor:[255,255,255]},
                        alternateRowStyles:{fillColor:[242,242,242]},
                        columnStyles:{
                            0:{halign:'left'},
                            1:{halign:'center'},
                            2:{halign:'center'},
                            3:{halign:'center'}
                        },
                        margin:{left:20,right:20}
                    });
                    yPosition = doc.lastAutoTable.finalY + 10;
                });
            }

            doc.setFont(undefined, 'bold');
            doc.text('Observações do Dia', 20, yPosition);
            yPosition += 8;
            const obsArray = sector === 'PARRILLA' ? appState.obsParrilla : appState.obsCozinha;
            if (obsArray.length === 0) {
                doc.setFont(undefined, 'normal');
                doc.text('Sem observações registradas para este período.', 20, yPosition);
            } else {
                const sorted = [...obsArray].sort((a,b) => a.id.localeCompare(b.id));
                sorted.forEach(obs => {
                    if (yPosition > 270) { doc.addPage(); yPosition = 20; }
                    doc.setFont(undefined, 'bold');
                    doc.text(`📅 ${formatDateBR(obs.id)}`, 20, yPosition);
                    yPosition += 6;
                    doc.setFont(undefined, 'normal');
                    const lines = doc.splitTextToSize(obs.texto || '', 170);
                    lines.forEach(line => {
                        if (yPosition > 270) { doc.addPage(); yPosition = 20; }
                        doc.text(line, 25, yPosition);
                        yPosition += 6;
                    });
                    yPosition += 4;
                });
            }

            doc.setFontSize(10);
            doc.text(`Gerado em ${dataBR}`, 20, 285);
            doc.text('App Estoque', 190, 285, {align:'right'});
            doc.save(`producao-${sector.toLowerCase()}-${dateFile}.pdf`);
            showMessage(`Relatório de produção ${sector} gerado com sucesso!`);
        }

        function generateShoppingList() {
            reportDisplayArea.classList.remove('hidden');
            reportDisplayArea.classList.add('interactive-list');
            const slSelectSize = 1;
           reportDisplayArea.innerHTML = `
                <div class="p-6">
                    <h2 class="text-lg font-semibold mb-4 text-gray-700">Lista de Compras</h2>
                    <p class="text-sm text-gray-500 mb-4">Gerado em: ${new Date().toLocaleDateString('pt-BR')} às ${new Date().toLocaleTimeString('pt-BR')}</p>
                    <div class="mb-4">
                        <label for="shopping-list-supplier-filter" class="block text-gray-700 text-sm font-bold mb-2">Filtrar por fornecedor:</label>
                        <select id="shopping-list-supplier-filter" class="supplier-select shadow appearance-none border rounded w-full py-2 px-3 text-gray-700 bg-white" size="${slSelectSize}">
                            <option value="TODOS">Todos os fornecedores</option>
                            ${appState.suppliers.map(supplier => {
                                const nome = supplier.nome || supplier.name || "";
                                return `<option value="${escapeHtml(nome)}">${escapeHtml(nome)}</option>`;
                            }).join('')}
                        </select>
                    </div>
                      <button id="generate-shopping-list-pdf-btn" class="btn btn-primary mb-4">Gerar Lista de Compras PDF</button>
                    <div id="shopping-list-items-container" class="space-y-3"></div>
                </div>
           `;

           const shoppingListSupplierFilter = document.getElementById('shopping-list-supplier-filter');
           const shoppingListItemsContainer = document.getElementById('shopping-list-items-container');
           const generateShoppingListPdfBtn = document.getElementById('generate-shopping-list-pdf-btn');
           if (appState.suppliersLoaded) {
               updateShoppingListSupplierFilter();
           }

            const renderShoppingListItems = () => {
                shoppingListItemsContainer.innerHTML = '';
                const selectedSupplier = shoppingListSupplierFilter.value;
                
                const filteredItems = appState.stockItems.filter(item => 
                    selectedSupplier === 'TODOS' || item.fornecedor === selectedSupplier
                ).sort((a, b) => a.item.localeCompare(b.item));

                if (filteredItems.length === 0) {
                    shoppingListItemsContainer.innerHTML = "<p class=\"text-gray-500\">Nenhum item no estoque para este fornecedor.</p>";
                    return;
                }

                // Agrupar por fornecedor para exibição
                const groupedBySupplier = {};
                filteredItems.forEach(item => {
                    if (!groupedBySupplier[item.fornecedor]) {
                        groupedBySupplier[item.fornecedor] = [];
                    }
                    groupedBySupplier[item.fornecedor].push(item);
                });

                Object.keys(groupedBySupplier).sort().forEach(supplier => {
                    const supplierHeader = document.createElement('h3');
                    supplierHeader.className = 'text-md font-medium text-gray-700 mt-4 mb-2';
                    supplierHeader.textContent = `Fornecedor: ${supplier}`;
                    shoppingListItemsContainer.appendChild(supplierHeader);

                    groupedBySupplier[supplier].forEach(item => {
                        const itemDiv = document.createElement('div');
                        itemDiv.className = 'flex items-center justify-between bg-gray-50 p-2 rounded-lg shadow-sm shopping-list-item';
                        itemDiv.dataset.supplier = item.fornecedor;
                        itemDiv.dataset.itemName = item.item;
                        itemDiv.dataset.currentQty = item.quantidadeAtual;
                        itemDiv.dataset.itemUnit = item.unidade;
                        itemDiv.innerHTML = `
                            <p class="font-semibold text-gray-800 w-1/3">${escapeHtml(item.item || '')}</p>
                            <p class="text-sm text-gray-600 w-1/4">${formatQty(item.quantidadeAtual)} ${escapeHtml(item.unidade || '')}</p>
                            <input type="number" class="w-1/4 p-1 border rounded text-center text-sm shopping-quantity-input" step="any">
                            <button class="delete-shopping-item bg-red-500 hover:bg-red-700 text-white text-xs font-bold py-1 px-2 rounded">Excluir</button>
                        `;
                        shoppingListItemsContainer.appendChild(itemDiv);
                    });
                });
            };

            shoppingListSupplierFilter.addEventListener('change', () => {
                renderShoppingListItems();
                saveShoppingListToFirestore();
            });
            generateShoppingListPdfBtn.addEventListener('click', generateShoppingListPDF);
            shoppingListItemsContainer.addEventListener('input', (e) => {
                if(e.target.classList.contains('shopping-quantity-input')){
                    saveShoppingListToFirestore();
                }
            });
            shoppingListItemsContainer.addEventListener('click', (e) => {
                if(e.target.classList.contains('delete-shopping-item')){
                    e.target.closest('.shopping-list-item').remove();
                    saveShoppingListToFirestore();
                }
            });
            renderShoppingListItems(); // Initial render
            loadShoppingListFromFirestore(shoppingListSupplierFilter, shoppingListItemsContainer, renderShoppingListItems);
        }

       function generateShoppingListPDF() {
           const { jsPDF } = window.jspdf;
           const doc = new jsPDF();
            const todayISO = formatDateISO(new Date());
            const dataBR = new Date().toLocaleDateString('pt-BR');
            const dateFile = formatDateFile(new Date());
            const horaBR = new Date().toLocaleTimeString('pt-BR');
            doc.setFont('helvetica');
            doc.setFontSize(11);
            doc.setTextColor(0,0,0);

            const selectedSupplier = reportDisplayArea.querySelector('#shopping-list-supplier-filter').value;
            const visibleItems = Array.from(reportDisplayArea.querySelectorAll('.shopping-list-item'))
                .filter(item => selectedSupplier === 'TODOS' || item.dataset.supplier === selectedSupplier);

            if (visibleItems.length === 0) {
                showMessage('Nenhum item encontrado!', true);
                return;
            }

            const supplierGroups = {};
            visibleItems.forEach(item => {
                const supplier = item.dataset.supplier;
                if (!supplierGroups[supplier]) supplierGroups[supplier] = [];

                const itemName = item.dataset.itemName;
                const currentQty = parseFloat(item.dataset.currentQty);
                const qtyInput = item.querySelector('.shopping-quantity-input');
                const qtyValue = qtyInput.value.trim();
                const requestedQty = qtyValue === '' ? 0 : parseFloat(qtyValue);
                const unit = item.dataset.itemUnit;

                supplierGroups[supplier].push({
                    name: itemName,
                    currentQty,
                    requestedQty,
                    unit
                });
            });

            // Lista de compras focada apenas em quantidades, sem precificação
            const sortedSuppliers = Object.keys(supplierGroups).sort();
            let lastY = 0;
            sortedSuppliers.forEach((supplier, supplierIndex) => {
                if (supplierIndex > 0) { doc.addPage(); }

                const items = supplierGroups[supplier].sort((a,b)=>a.name.localeCompare(b.name));
                doc.setFontSize(16); doc.setFont(undefined,'bold');
                doc.text('Lista de Compras', 20, 20);
                doc.setFontSize(12); doc.text(`Fornecedor: ${supplier}`, 20, 30);
                doc.setFontSize(11); doc.setFont(undefined,'normal');
                doc.text(`Data: ${dataBR}`, 20, 40);
                doc.text(`Hora: ${horaBR}`, 20, 46);

                const body = items.map(it => [
                    it.name,
                    formatQty(it.currentQty || 0),
                    it.requestedQty ? formatQty(it.requestedQty) : '',
                    it.unit
                ]);

                doc.autoTable({
                    head: [['Item','Qtd. Atual','Qtd. Comprar','Unidade']],
                    body,
                    startY: 60,
                    styles:{fontSize:11, lineHeight:1.1, cellPadding:4, noWrap:false, textColor:0},
                    headStyles:{fillColor:[217,217,217], textColor:0, fontStyle:'bold'},
                    bodyStyles:{fillColor:[255,255,255]},
                    alternateRowStyles:{fillColor:[242,242,242]},
                    columnStyles:{
                        0:{halign:'left'},
                        1:{halign:'center'},
                        2:{halign:'center'},
                        3:{halign:'center'}
                    },
                    margin:{left:20,right:20}
                });
                lastY = doc.lastAutoTable.finalY + 10;
                doc.setFont(undefined,'bold');
                doc.text(`Total de itens: ${items.length}`, 20, lastY);
            });



            doc.setFontSize(10);
            doc.text(`Gerado em ${dataBR}`, 20, 285);
            doc.text('App Estoque', 190, 285, {align:'right'});
            doc.save(`relatorio-lista-compras-${todayISO}.pdf`);
            showMessage('Lista de compras gerada com sucesso!');
        }

        function generateEtiquetas(produto, dataProd, validade, tipo) {
            const { jsPDF } = window.jspdf;
            const docPdf = new jsPDF({orientation:'portrait', unit:'mm', format:[50,80]});
            const codigo = Math.random().toString(36).substring(2,8).toUpperCase();
            const pageWidth = docPdf.internal.pageSize.getWidth();
            let y = 6;
            docPdf.setFont('helvetica','bold');
            docPdf.setFontSize(16);
            docPdf.setTextColor(0,0,0);
            docPdf.text('MATTURADO', pageWidth/2, y, {align:'center'});
            docPdf.setFont('helvetica','normal');
            docPdf.setFontSize(12);
            y += 7;
            docPdf.text(`Produto: ${produto}`, pageWidth/2, y, {align:'center'});
            y += 7;
            docPdf.text(`Produção: ${formatDateBR(dataProd)}`, pageWidth/2, y, {align:'center'});
            y += 7;
            if(validade){
                docPdf.text(`Validade: ${formatDateBR(validade)}`, pageWidth/2, y, {align:'center'});
                y += 7;
            }
            docPdf.text(`Tipo: ${tipo}`, pageWidth/2, y, {align:'center'});
            y += 7;
            docPdf.setFont('helvetica','bold');
            docPdf.text(`Código: ${codigo}`, pageWidth/2, y, {align:'center'});
            docPdf.setFont('helvetica','normal');
            const pdfBlob = docPdf.output('blob');
            const fileURL = URL.createObjectURL(pdfBlob);
            window.location.href = fileURL;
            if(navigator.share){
                navigator.share({title:'Etiqueta de Produção', url:fileURL}).catch(()=>{});
            }
        }

        function showBalanceSummary() {
            if(!balanceSummaryDiv || !balanceSummaryModal) return;
            const rows = Array.from(document.querySelectorAll('.balance-row'));
            if (rows.length === 0) { balanceSummaryDiv.innerHTML = '<p class="text-gray-500">Nenhum item.</p>'; balanceSummaryModal.classList.remove('hidden'); return; }
            const table = document.createElement('table');
            table.className = 'min-w-full divide-y divide-gray-200 text-sm';
            table.innerHTML = `<thead class="bg-gray-50"><tr>
                <th class="p-2 text-left">Item</th>
                <th class="p-2 text-center">Unidade</th>
                <th class="p-2 text-center">Estoque Atual</th>
                <th class="p-2 text-center">Contagem Real</th>
                <th class="p-2 text-center">Diferença</th>
                <th class="p-2 text-left">Justificativa</th>
            </tr></thead><tbody></tbody>`;
            const tbody = table.querySelector('tbody');
            let diffTotal = 0;
            rows.forEach(r => {
                const nome = r.dataset.name;
                const unidade = r.dataset.unit || '';
                const current = parseFloat(r.dataset.current || '0');
                const cont = parseFloat(r.querySelector('.contagem-input').value) || 0;
                const diff = current - cont;
                diffTotal += diff;
                const just = r.dataset.justificativa || '';
                const tr = document.createElement('tr');
                const diffClass = diff > 0 ? 'text-red-600' : diff === 0 ? 'text-green-600' : 'text-yellow-600';
                tr.innerHTML = `
                    <td class="p-2">${escapeHtml(nome)}</td>
                    <td class="p-2 text-center">${escapeHtml(unidade)}</td>
                    <td class="p-2 text-center">${formatQty(current)}</td>
                    <td class="p-2 text-center">${formatQty(cont)}</td>
                    <td class="p-2 text-center ${diffClass}">${formatQty(diff)}</td>
                    <td class="p-2">${escapeHtml(just)}</td>`;
                tbody.appendChild(tr);
            });
            const tfoot = document.createElement('tfoot');
            tfoot.innerHTML = `<tr class="bg-gray-50 font-semibold"><td class="p-2" colspan="5">Total Diferença</td><td class="p-2 text-center">${formatQty(diffTotal)}</td></tr>`;
            table.appendChild(tfoot);
            const closeBtn = document.createElement('button');
            closeBtn.textContent = 'Fechar';
            closeBtn.className = 'mt-4 bg-red-500 hover:bg-red-700 text-white font-bold py-1 px-2 rounded text-sm';
            closeBtn.addEventListener('click', ()=> balanceSummaryModal.classList.add('hidden'));
            balanceSummaryDiv.innerHTML = '';
            balanceSummaryDiv.appendChild(table);
            balanceSummaryDiv.appendChild(closeBtn);
            balanceSummaryModal.classList.remove('hidden');
        }

        async function applyBalance() {
            const rows = Array.from(document.querySelectorAll('.balance-row'));
            if (rows.length === 0) return;
            const filledRows = rows.filter(r => r.querySelector('.contagem-input').value.trim() !== '');
            if(filledRows.length === 0){ showMessage('Preencha ao menos uma contagem', true); return; }
            const groups = { fornecedor: [], cozinha: [], parrilla: [] };
            const now = new Date().toISOString();
            for (const r of filledRows) {
                const tipo = r.dataset.tipo;
                const id = r.dataset.id;
                const nome = r.dataset.name;
                const unidade = r.dataset.unit || '';
                const current = parseFloat(r.dataset.current || '0');
                const cont = parseFloat(r.querySelector('.contagem-input').value) || 0;
                const diff = current - cont;
                const just = r.dataset.justificativa ? r.dataset.justificativa.trim() : '';
                groups[tipo].push({ nome, unidade, quantidadeSistema: current, contagemReal: cont, diferenca: diff, justificativa: just, atualizado: true, dataHora: now });
                try {
                    if (tipo === 'fornecedor') {
                        const item = appState.stockItems.find(it => it.id === id) || {};
                        const historico = Array.isArray(item.historicoEntradas) ? [...item.historicoEntradas] : [];
                        historico.push({ tipo: 'balanco', quantidade: cont, dataHora: now });
                        await updateDoc(docEmp('estoque', id), {
                            quantidadeAtual: cont,
                            origem: 'balanco',
                            historicoEntradas: historico,
                            ultimaAtualizacao: now,
                            atualizado: true
                        });
                    } else {
                        await updateDoc(docEmp('producao', id), {
                            quantidade: cont,
                            origem: 'balanco',
                            timestamp: now,
                            atualizado: true
                        });
                        await addDoc(colEmp('producao', id, 'historicoInclusoes'), {
                            quantidade: cont,
                            origem: 'balanco',
                            dataHora: now
                        });
                    }
                } catch (e) { console.error('Erro ao atualizar', e); }
            }
            const dateKey = formatDateISO(now);
            for(const t of Object.keys(groups)){
                if(groups[t].length>0){
                    await setDoc(docEmp('balanco',dateKey,t), { tipo:t, itens: groups[t], responsavel: auth.currentUser ? auth.currentUser.email : '' });
                }
            }
            const tempKey = new Date().toLocaleDateString('pt-BR').replace(/\//g,'-');
            const user = auth.currentUser;
            if(user){
                try{ await deleteDoc(docEmp('balanco_temp', user.email, appState.currentBalanceGroup, tempKey)); }catch(e){ console.error('Erro ao limpar balanco_temp', e); }
            }
            appState.tempBalancePrompted = false;
            rows.forEach(r => { const inp = r.querySelector('.contagem-input'); if(inp) inp.value = ''; r.dataset.justificativa = ''; });
            showMessage('Estoque atualizado com sucesso.');
            checkBalanceInputs();
        }

       function generateBalancePDF() {
           const rows = Array.from(document.querySelectorAll('.balance-row'));
           if(rows.length === 0) { showMessage('Nenhum item encontrado', true); return; }
           const { jsPDF } = window.jspdf;
           const docPdf = new jsPDF();
           const todayISO = formatDateISO(new Date());
           const dataBR = new Date().toLocaleDateString('pt-BR');
           const dateFile = formatDateFile(new Date());
           const horaBR = new Date().toLocaleTimeString('pt-BR');
           const responsavel = auth.currentUser ? auth.currentUser.email : '';
           const label = appState.currentBalanceGroup === 'fornecedor' ? 'Por Fornecedor' : (appState.currentBalanceGroup === 'cozinha' ? 'Produção Cozinha' : 'Produção Parrilla');
           docPdf.setFont('helvetica');
           docPdf.setTextColor(0,0,0);
            if(appState.currentBalanceGroup === 'fornecedor'){
                const groups = {};
                rows.forEach(r => {
                    const sup = r.dataset.supplier || 'Outros';
                    const nome = r.dataset.name;
                    const current = parseFloat(r.dataset.current||'0');
                    const cont = parseFloat(r.querySelector('.contagem-input').value)||0;
                    const diff = current - cont;
                    const just = r.dataset.justificativa || '';
                    if(!groups[sup]) groups[sup] = [];
                    groups[sup].push([nome,formatQty(current),formatQty(cont),formatQty(diff),just]);
                });
                const suppliers = Object.keys(groups).sort();
                suppliers.forEach((sup,idx) => {
                    if(idx>0) docPdf.addPage();
                    docPdf.setFontSize(16); docPdf.text(`Balanço de Estoque - ${sup}`,20,20);
                    docPdf.setFontSize(11); docPdf.text(`Data: ${dataBR}`,20,30); docPdf.text(`Hora: ${horaBR}`,20,36); if(responsavel) docPdf.text(`Responsável: ${responsavel}`,20,42);
                    const startY = responsavel ? 51 : 45;
                    docPdf.autoTable({head:[['Item','Sistema','Contado','Diferença','Justificativa']], body: groups[sup], startY, styles:{fontSize:11,lineHeight:1.1,cellPadding:4,noWrap:false, textColor:0}, headStyles:{fillColor:[217,217,217],textColor:0,fontStyle:'bold'}, alternateRowStyles:{fillColor:[242,242,242]}, margin:{left:20,right:20}});
                });
            } else {
                docPdf.setFontSize(16); docPdf.text(`Balanço de Estoque - ${label}`,20,20);
                docPdf.setFontSize(11); docPdf.text(`Data: ${dataBR}`,20,30); docPdf.text(`Hora: ${horaBR}`,20,36); if(responsavel) docPdf.text(`Responsável: ${responsavel}`,20,42);
                const startY = responsavel ? 51 : 45;
                const body = rows.map(r => {
                    const nome = r.dataset.name;
                    const current = parseFloat(r.dataset.current||'0');
                    const cont = parseFloat(r.querySelector('.contagem-input').value)||0;
                    const diff = current - cont;
                    const just = r.dataset.justificativa || '';
                    return [nome, formatQty(current), formatQty(cont), formatQty(diff), just];
                });
                docPdf.autoTable({head:[['Item','Sistema','Contado','Diferença','Justificativa']], body, startY, styles:{fontSize:11,lineHeight:1.1,cellPadding:4,noWrap:false, textColor:0}, headStyles:{fillColor:[217,217,217],textColor:0,fontStyle:'bold'}, alternateRowStyles:{fillColor:[242,242,242]}, margin:{left:20,right:20}});
            }
            docPdf.setFontSize(10); docPdf.text('Gerado por Trakto FoodOps | appestoque.vercel.app', docPdf.internal.pageSize.getWidth()/2, 285, {align:'center'});
            docPdf.save(`balanco-${appState.currentBalanceGroup}-${dateFile}.pdf`);
       }

        // Alias functions connected to the UI buttons
        function gerarResumoBalanco() {
            console.log('Resumo acionado');
            showBalanceSummary();
        }

        async function aplicarBalancoEstoque() {
            const msg = 'Deseja aplicar o balanço e atualizar os estoques dos itens preenchidos?';
            if(!confirm(msg)) return;
            await applyBalance();
        }

        function exportarBalancoPDF() {
            console.log('PDF acionado');
            generateBalancePDF();
        }

        function switchBalanceView(view){
            document.querySelectorAll('.balance-view-button').forEach(b => b.classList.remove('btn-primary'));
            const btn = document.querySelector(`.balance-view-button[data-view="${view}"]`);
            if(btn) btn.classList.add('btn-primary');
            if(balanceNewView) balanceNewView.classList.toggle('hidden', view !== 'novo');
            if(balanceHistoryView) balanceHistoryView.classList.toggle('hidden', view !== 'historico');
            if(view === 'historico') loadBalanceHistory();
        }

        async function loadBalanceHistory(){
            if(!historyListDiv) return;
            historyListDiv.innerHTML = '<p class="text-gray-500">Carregando...</p>';
            let records = [];
            const types = historyTypeFilter && historyTypeFilter.value ? [historyTypeFilter.value] : ['fornecedor','cozinha','parrilla'];
            for(const tp of types){
                const q = query(collectionGroup(db, tp));
                const snap = await getDocs(q);
                snap.forEach(docSnap => {
                    const dateKey = docSnap.ref.parent.parent.id;
                    const data = docSnap.data();
                    records.push({ date: dateKey, tipo: tp, itens: data.itens || [], responsavel: data.responsavel || '' });
                });
            }
            if(historyDateFilter && historyDateFilter.value){
                const prefix = historyDateFilter.value;
                records = records.filter(r => r.date.startsWith(prefix));
            }
            records.sort((a,b) => b.date.localeCompare(a.date));
            appState.balanceHistoryRecords = records;
            if(records.length === 0){
                historyListDiv.innerHTML = '<p class="text-gray-500">Nenhum balanço encontrado.</p>';
                return;
            }
            const table = document.createElement('table');
            table.className = 'min-w-full divide-y divide-gray-200 text-sm';
            table.innerHTML = `<thead class="bg-gray-50"><tr><th class="p-2 text-left">Data</th><th class="p-2 text-left">Tipo</th><th class="p-2 text-center">Quantidade de Itens</th><th class="p-2 text-center">Total da Diferença</th><th class="p-2 text-center">Ação</th></tr></thead><tbody></tbody>`;
            const tbody = table.querySelector('tbody');
            records.forEach((rec,i) => {
                const diffTot = rec.itens.reduce((s,it)=> s + (Number(it.diferenca)||0),0);
                const tr = document.createElement('tr');
                const label = rec.tipo === 'fornecedor' ? 'Por Fornecedor' : (rec.tipo==='cozinha' ? 'Produção Cozinha' : 'Produção Parrilla');
                tr.innerHTML = `<td class="p-2">${formatDateBR(rec.date)}</td><td class="p-2">${label}</td><td class="p-2 text-center">${rec.itens.length}</td><td class="p-2 text-center">${formatQty(diffTot)}</td><td class="p-2 text-center"><button class="history-details-btn text-blue-600 underline text-sm" data-idx="${i}">Ver Detalhes</button></td>`;
                tbody.appendChild(tr);
            });
            historyListDiv.innerHTML = '';
            historyListDiv.appendChild(table);
        }

        function showHistoryDetails(rec){
            if(!historyModal) return;
            const diffTot = rec.itens.reduce((s,it)=> s + (Number(it.diferenca)||0),0);
            const modalBox = document.createElement('div');
            modalBox.className = 'bg-white p-4 rounded shadow-lg max-h-full overflow-auto w-full max-w-2xl';
            const label = rec.tipo === 'fornecedor' ? 'Por Fornecedor' : (rec.tipo==='cozinha' ? 'Produção Cozinha' : 'Produção Parrilla');
            modalBox.innerHTML = `<h3 class="text-lg font-semibold mb-2">${formatDateBR(rec.date)} - ${label}</h3><p class="text-sm text-gray-600 mb-2">${rec.responsavel ? 'Responsável: '+escapeHtml(rec.responsavel) : ''}</p><div class="max-h-80 overflow-auto"><table class="min-w-full divide-y divide-gray-200 text-sm"><thead class="bg-gray-50"><tr><th class="p-2 text-left">Item</th><th class="p-2 text-center">Unidade</th><th class="p-2 text-center">Sistema</th><th class="p-2 text-center">Contagem Real</th><th class="p-2 text-center">Diferença</th><th class="p-2 text-left">Justificativa</th></tr></thead><tbody>${rec.itens.map(it=>`<tr><td class="p-2">${escapeHtml(it.nome||'')}</td><td class="p-2 text-center">${escapeHtml(it.unidade||'')}</td><td class="p-2 text-center">${formatQty(it.quantidadeSistema||0)}</td><td class="p-2 text-center">${formatQty(it.contagemReal||0)}</td><td class="p-2 text-center">${formatQty(it.diferenca||0)}</td><td class="p-2">${escapeHtml(it.justificativa||'')}</td></tr>`).join('')}</tbody></table></div><div class="flex justify-between items-center mt-4"><span class="font-semibold">Total Diferença: ${formatQty(diffTot)}</span><div class="flex gap-2"><button id="export-history-pdf-btn" class="bg-gray-500 hover:bg-gray-700 text-white font-bold py-1 px-2 rounded text-sm">Exportar PDF do Balanço</button><button id="close-history-modal" class="bg-red-500 hover:bg-red-700 text-white font-bold py-1 px-2 rounded text-sm">Fechar</button></div></div>`;
            historyModal.innerHTML = '';
            historyModal.appendChild(modalBox);
            historyModal.classList.remove('hidden');
            document.getElementById('close-history-modal').addEventListener('click', ()=> historyModal.classList.add('hidden'));
            document.getElementById('export-history-pdf-btn').addEventListener('click', ()=> generateHistoricBalancePDF(rec));
        }

        function generateHistoricBalancePDF(rec){
            const { jsPDF } = window.jspdf;
            const docPdf = new jsPDF();
            const dataBR = formatDateBR(rec.date);
            const dateFile = formatDateFile(rec.date);
            const horaBR = new Date().toLocaleTimeString('pt-BR');
            const label = rec.tipo === 'fornecedor' ? 'Por Fornecedor' : (rec.tipo==='cozinha' ? 'Produção Cozinha' : 'Produção Parrilla');
            docPdf.setFont('helvetica');
            docPdf.setTextColor(0,0,0);
            docPdf.setFontSize(16); docPdf.text(`Balanço de Estoque - ${label}`,20,20);
            docPdf.setFontSize(11); docPdf.text(`Data: ${dataBR}`,20,30); docPdf.text(`Hora: ${horaBR}`,20,36); if(rec.responsavel) docPdf.text(`Responsável: ${rec.responsavel}`,20,42);
            const body = rec.itens.map(it => [it.nome, formatQty(it.quantidadeSistema||0), formatQty(it.contagemReal||0), formatQty(it.diferenca||0), it.justificativa||'']);
            docPdf.autoTable({head:[['Item','Sistema','Contado','Diferença','Justificativa']], body, startY: 55, styles:{fontSize:11, lineHeight:1.1, cellPadding:4, noWrap:false, textColor:0}, headStyles:{fillColor:[217,217,217], textColor:0, fontStyle:'bold'}, alternateRowStyles:{fillColor:[242,242,242]}, margin:{left:20,right:20}});
            docPdf.setFontSize(10); docPdf.text('App Estoque',190,285,{align:'right'});
            docPdf.save(`balanco-${rec.tipo}-${dateFile}.pdf`);
        }

        // Global functions for inline event handlers
        window.handleEntradaInput = (input) => {
            const row = input.closest('tr');
            const totalCell = row.querySelector('.total-atualizado');
            const current = parseFloat(input.dataset.current || '0');
            const val = parseFloat(input.value);
            row.classList.remove('entrada-highlight', 'zeramento-highlight');
            if (isNaN(val)) {
                totalCell.textContent = '';
                return;
            }
            if (val === 0) {
                totalCell.textContent = '0';
                row.classList.add('zeramento-highlight');
            } else {
                totalCell.textContent = formatQty(current + val);
                row.classList.add('entrada-highlight');
            }
        };

        window.saveEntrada = async (id) => {
            const input = document.querySelector(`input[data-item-id="${id}"][data-update-type="entrada"]`);
            if (!input) return;
            const valor = parseFloat(input.value);
            if (isNaN(valor)) {
                showMessage('Quantidade inválida', true);
                return;
            }
            const item = appState.stockItems.find(it => it.id === id);
            if (!item) return;
            const historico = Array.isArray(item.historicoEntradas) ? [...item.historicoEntradas] : [];
            const agora = new Date().toISOString();
            let novaQtd = 0;
            let tipo = 'entrada';
            if (valor === 0) {
                tipo = 'zeramento';
            } else {
                novaQtd = (item.quantidadeAtual || 0) + valor;
            }
            if (valor === 0) {
                novaQtd = 0;
            }
            historico.push({ tipo, quantidade: valor, dataHora: agora });
            try {
                await updateDoc(docEmp('estoque', id), {
                    quantidadeAtual: novaQtd,
                    historicoEntradas: historico,
                    ultimaAtualizacao: agora
                });
                showMessage('Entrada salva com sucesso!');
                input.value = '';
            } catch (error) {
                console.error('Erro ao salvar entrada:', error);
                showMessage('Erro ao salvar entrada', true);
            }
        };

        window.deleteStockItem = async (id) => {
            if (confirm('Tem certeza que deseja excluir este item?')) {
                try {
                    await deleteDoc(docEmp('estoque', id));
                    showMessage('Item excluído com sucesso!');
                } catch (error) {
                    console.error('Erro ao excluir item:', error);
                    showMessage('Erro ao excluir item', true);
                }
            }
        };

        window.updateProductionItem = async (id) => {
            const input = document.querySelector(`input[data-item-id="${id}"]`);
            if (!input) return;

            const delta = parseFloat(input.value);
            if (isNaN(delta)) {
                showMessage('Quantidade inválida', true);
                return;
            }

            try {
                const ref = docEmp('producao', id);
                await updateDoc(ref, {
                    quantidade: increment(delta),
                    timestamp: new Date().toISOString()
                });
                await addDoc(collection(ref, 'historicoInclusoes'), {
                    quantidade: delta,
                    dataHora: new Date().toISOString()
                });
                showMessage('Produção registrada com sucesso!');
                input.value = '';
            } catch (error) {
                console.error('Erro ao atualizar item:', error);
                showMessage('Erro ao atualizar quantidade', true);
            }
        };
        window.deleteProductionItem = async (id) => {
            if (confirm('Tem certeza que deseja excluir este item?')) {
                try {
                    await deleteDoc(docEmp('producao', id));
                    showMessage('Item excluído com sucesso!');
                } catch (error) {
                    console.error('Erro ao excluir item:', error);
                    showMessage('Erro ao excluir item', true);
                }
            }
        };

        window.deleteSupplier = async (id) => {
            if (confirm('Tem certeza que deseja excluir este fornecedor?')) {
                try {
                    await deleteDoc(docEmp('fornecedores', id));
                    showMessage('Fornecedor excluído com sucesso!');
                } catch (error) {
                    console.error('Erro ao excluir fornecedor:', error);
                    showMessage('Erro ao excluir fornecedor', true);
                }
            }
        };

        window.editObservation = (sector, date) => {
            const obsArr = sector === 'parrilla' ? appState.obsParrilla : appState.obsCozinha;
            const obs = obsArr.find(o => o.id === date);
            if (!obs) return;
            if (sector === 'parrilla') {
                parrillaObsDate.value = date;
                parrillaObsText.value = obs.texto || '';
                appState.editingObs.parrilla = date;
            } else {
                cozinhaObsDate.value = date;
                cozinhaObsText.value = obs.texto || '';
                appState.editingObs.cozinha = date;
            }
        };

        window.deleteObservation = async (sector, date) => {
            if (!confirm('Excluir observação?')) return;
            try {
                await deleteDoc(docEmp('observacoesProducao', sector, 'dias', date));
                showMessage('Observação excluída!');
            } catch (e) {
                console.error('Erro ao excluir observação:', e);
                showMessage('Erro ao excluir observação', true);
            }
        };

        window.deleteFicha = async (id) => {
            if (!confirm('Excluir ficha?')) return;
            try {
                await deleteDoc(docEmp('fichasTecnicas', id));
                showMessage('Ficha excluída!');
            } catch (err) {
                console.error('Erro ao excluir ficha:', err);
                showMessage('Erro ao excluir ficha', true);
            }
        };

        window.generateFichaPdf = async (id) => {
            const ficha = appState.fichasTecnicas.find(f => f.id === id);
            if (!ficha) return;
            const { jsPDF } = window.jspdf;
            const docPdf = new jsPDF();
            const todayISO = formatDateISO(new Date());
            const dateFile = formatDateFile(new Date());
            docPdf.setFont("helvetica");
            docPdf.setFontSize(11);
            docPdf.setTextColor(0,0,0);

            docPdf.setFontSize(16);
            docPdf.text(ficha.nome, 20, 20);
            docPdf.setFontSize(12);
            docPdf.text(`Categoria: ${ficha.categoria}`, 20, 30);
            docPdf.text(`Data: ${new Date(ficha.dataCriacao.seconds*1000).toLocaleDateString('pt-BR')}`, 20, 38);

            const tableBody = ficha.ingredientes.map(ing => [
                ing.nome,
                formatQty(ing.qtdLiquida || 0),
                ing.fc ? formatQty(ing.fc) : '',
                formatQty(ing.qtdBruta || 0),
                ing.unidade,
                `R$ ${Number(ing.custoTotal || 0).toFixed(2)}`
            ]);

            docPdf.autoTable({
                head: [['Ingrediente', 'Qtd. Líquida', 'FC', 'Qtd. Bruta', 'Unidade', 'Custo Total']],
                body: tableBody,
                startY: 50,
                styles: { fontSize: 11, lineHeight: 1.1, cellPadding: 4, noWrap:false, textColor: 0 },
                headStyles: { fillColor: [217,217,217], textColor: 0, fontStyle: 'bold' },
                bodyStyles: { fillColor: [255,255,255] },
                alternateRowStyles: { fillColor: [242,242,242] },
                columnStyles: {
                    0: { halign: 'left' },
                    1: { halign: 'center' },
                    2: { halign: 'center' },
                    3: { halign: 'center' },
                    4: { halign: 'center' },
                    5: { halign: 'center' }
                }
            });

            let y = docPdf.lastAutoTable.finalY + 10;
            docPdf.text(`Custo total: R$ ${ficha.custoTotal.toFixed(2)}`, 20, y); y+=6;
            docPdf.text(`Rendimento: ${ficha.rendimento}`, 20, y); y+=6;
            docPdf.text(`Custo por porção: R$ ${ficha.custoPorPorcao.toFixed(2)}`, 20, y); y+=6;
            docPdf.text(`CMV aplicado: ${ficha.cmvAplicado.toFixed(2)}%`, 20, y); y+=6;
            docPdf.text(`Preço sugerido: R$ ${ficha.precoSugerido.toFixed(2)}`, 20, y); y+=6;
            if(ficha.precoReal){ docPdf.text(`Preço real: R$ ${ficha.precoReal.toFixed(2)}`, 20, y); y+=6; }
            docPdf.text(`CMV real: ${ficha.cmvReal.toFixed(2)}%`, 20, y); y+=6;
            docPdf.text(`Margem de lucro: ${ficha.margemLucro.toFixed(2)}%`, 20, y);

            docPdf.setFontSize(10);
            docPdf.text(`Gerado em ${new Date().toLocaleDateString('pt-BR')}`, 20, 285);
            docPdf.text('App Estoque', 190, 285, {align:'right'});
            docPdf.save(`relatorio-ficha-tecnica-${dateFile}.pdf`);
        };

        // Event Listeners
        showSignupBtn.addEventListener('click', () => {
            loginView.classList.add('hidden');
            signupView.classList.remove('hidden');
        });

        showLoginBtn.addEventListener('click', () => {
            signupView.classList.add('hidden');
            loginView.classList.remove('hidden');
        });

        // ALTERACAO: listeners separados para Admin e Voltar  
        adminLinkEl.addEventListener('click', () => { toggleViews('admin-view'); });
        voltarMainBtn.addEventListener('click', () => { toggleViews('main-app-view'); });



        onAuthStateChanged(auth, async (user) => {
            if (user) {
                const token = await getIdTokenResult(user);
                const roleClaim = token.claims.role;
                document.getElementById("user-email").textContent = user.email;
                if (roleClaim === 'superadmin') {
                    userRole = 'superadmin';
                    toggleViews('admin-view');
                    document.getElementById('superadmin-section').classList.remove('hidden');
                    document.getElementById('admin-section').classList.add('hidden');
                    loadCompanies();
                    if(dashboardView) dashboardView.classList.add('hidden');
                } else {
                    const role = await loadCompanyByEmail(user.email);
                    if (role === null) {
                        showMessage('Nenhuma empresa encontrada. Peça ao superadmin para definir uma empresa ou verifique suas credenciais.', true);
                        await signOut(auth);
                        return;
                    }
                    userRole = role || 'usuario';
                    if(userRole === 'admin') adminLinkEl.classList.remove('hidden'); else adminLinkEl.classList.add('hidden');
                    toggleViews('main-app-view');
                    dashboardView.classList.remove('hidden');
                    tabContents.forEach(t => t.classList.remove('active'));
                    document.querySelectorAll('.tab-button').forEach(b => b.classList.remove('active'));
                    listenToDataChanges();
                    updateEtiquetaProdutoSelect();
                    updateDashboard();
                    cleanupOldTempBalances();
                }
            } else {
                toggleViews("login-view");
                if(dashboardView) dashboardView.classList.add('hidden');
                if (appState.unsubscribeStock) appState.unsubscribeStock();
                if (appState.unsubscribeProduction) appState.unsubscribeProduction();
                if (appState.unsubscribeSuppliers) appState.unsubscribeSuppliers();
                if (appState.unsubscribeObsParrilla) appState.unsubscribeObsParrilla();
                if (appState.unsubscribeObsCozinha) appState.unsubscribeObsCozinha();
                if (appState.unsubscribeFichasTecnicas) appState.unsubscribeFichasTecnicas();
                if (appState.unsubscribeFC) appState.unsubscribeFC();
                appState.fcValues = {};
                appState.suppliersLoaded = false;
            }
        });

        loginForm.addEventListener('submit', async (e) => {
            e.preventDefault();
            const email = document.getElementById('login-email').value;
            const password = document.getElementById('login-password').value;
            lastLoginPassword = password;

            try {
                await signInWithEmailAndPassword(auth, email, password);
                showMessage('Login realizado com sucesso!');
            } catch (error) {
                console.error('Erro no login:', error);
                showMessage('Erro no login: ' + error.message, true);
            }
        });

        signupForm.addEventListener('submit', async (e) => {
            e.preventDefault();
            const email = document.getElementById('signup-email').value;
            const password = document.getElementById('signup-password').value;
            
            try {
                await createUserWithEmailAndPassword(auth, email, password);
                showMessage('Conta criada com sucesso!');
            } catch (error) {
                console.error('Erro no cadastro:', error);
                showMessage('Erro no cadastro: ' + error.message, true);
            }
        });

        logoutBtn.addEventListener('click', async () => {
            try {
                await signOut(auth);
                showMessage('Logout realizado com sucesso!');
            } catch (error) {
                console.error('Erro no logout:', error);
                showMessage('Erro no logout', true);
            }
        });

        if(addCompanyForm){
            addCompanyForm.addEventListener('submit', async (e) => {
                e.preventDefault();
                const razao = document.getElementById('empresa-razao').value.trim();
                const cnpj = document.getElementById('empresa-cnpj').value.trim();
                const endereco = document.getElementById('empresa-endereco').value.trim();
                const adminEmail = document.getElementById('empresa-admin-email').value.trim();
                const adminSenha = document.getElementById('empresa-admin-senha').value;
                const currentEmail = auth.currentUser.email;
                try {
                    await setDoc(doc(db,'empresas', cnpj), {razao, cnpj, endereco});
                    const cred = await createUserWithEmailAndPassword(auth, adminEmail, adminSenha);
                    await setDoc(doc(db,'empresas', cnpj, 'usuarios', cred.user.uid), {email: adminEmail, role:'admin'});
                    await signOut(auth);
                    await signInWithEmailAndPassword(auth, currentEmail, lastLoginPassword);
                    addCompanyForm.reset();
                    loadCompanies();
                    showMessage('Empresa cadastrada');
                } catch(err){
                    console.error('Erro ao cadastrar empresa', err);
                    showMessage('Erro ao cadastrar empresa', true);
                }
            });
        }

        if(addUserForm){
            addUserForm.addEventListener('submit', async (e) => {
                e.preventDefault();
                const email = document.getElementById('novo-usuario-email').value.trim();
                const senha = document.getElementById('novo-usuario-senha').value;
                const currentEmail = auth.currentUser.email;
                try {
                    const cred = await createUserWithEmailAndPassword(auth, email, senha);
                    await setDoc(docEmp('usuarios', cred.user.uid), {email, role:'usuario'});
                    await signOut(auth);
                    await signInWithEmailAndPassword(auth, currentEmail, lastLoginPassword);
                    addUserForm.reset();
                    loadUsers();
                    showMessage('Usuário criado');
                } catch(err){
                    console.error('Erro ao criar usuário', err);
                    showMessage('Erro ao criar usuário', true);
                }
            });
            usuariosListDiv.addEventListener('click', async (e) => {
                if(e.target.classList.contains('delete-user')){
                    const uid = e.target.dataset.uid;
                    await deleteDoc(docEmp('usuarios', uid));
                    loadUsers();
                }
            });
            if(importFileInput){
                importFileInput.addEventListener('change', (e)=>{
                    const f = e.target.files[0];
                    if(f) importStockFile(f);
                });
            }
        }

        addItemForm.addEventListener('submit', async (e) => {
            e.preventDefault();
            const name = document.getElementById('product-name').value;
            const supplier = document.getElementById('product-supplier').value;
            if (!supplier) {
                showMessage('Selecione um fornecedor', true);
                return;
            }
            const quantity = parseFloat(document.getElementById('product-quantity').value);
            const min = parseFloat(document.getElementById('product-min').value) || 0;
            const ideal = parseFloat(document.getElementById('product-ideal').value) || 0;
            const unit = document.getElementById('product-unit').value;
            const price = parseFloat(document.getElementById('product-price').value) || 0;
            
            try {
                await addDoc(colEmp('estoque'), {
                    item: name,
                    fornecedor: supplier,
                    quantidadeAtual: quantity,
                    minimo: min,
                    ideal: ideal,
                    unidade: unit,
                    preco: price,
                    historicoEntradas: [],
                    ultimaAtualizacao: new Date().toISOString(),
                    timestamp: new Date().toISOString()
                });
                showMessage('Item adicionado com sucesso!');
                addItemForm.reset();
            } catch (error) {
                console.error('Erro ao adicionar item:', error);
                showMessage('Erro ao adicionar item', true);
            }
        });

        addProductionForm.addEventListener('submit', async (e) => {
            e.preventDefault();
            const name = document.getElementById('production-name').value;
            const sector = document.getElementById('production-sector').value;
            const quantity = parseFloat(document.getElementById('production-quantity').value);
            const unit = document.getElementById('production-unit').value;

            try {
                const docRef = await addDoc(colEmp('producao'), {
                    item: name,
                    setor: sector,
                    quantidade: quantity,
                    unidade: unit,
                    timestamp: new Date().toISOString()
                });
                await addDoc(colEmp('producao', docRef.id, 'historicoInclusoes'), {
                    quantidade: quantity,
                    dataHora: new Date().toISOString()
                });
                showMessage('Item de produção adicionado com sucesso!');
                addProductionForm.reset();
            } catch (error) {
                console.error('Erro ao adicionar item de produção:', error);
                showMessage('Erro ao adicionar item de produção', true);
            }
        });

        if(etiquetaForm){
            etiquetaProducaoInput.value = formatDateISO(new Date());
            const updateCustomInput = () => {
                if(etiquetaProdutoSelect.value === 'CUSTOM'){
                    etiquetaProdutoCustom.classList.remove('hidden');
                    etiquetaProdutoCustom.required = true;
                } else {
                    etiquetaProdutoCustom.classList.add('hidden');
                    etiquetaProdutoCustom.required = false;
                }
            };
            etiquetaProdutoSelect.addEventListener('change', updateCustomInput);
            updateCustomInput();
            etiquetaForm.addEventListener('submit', (e) => {
                e.preventDefault();
                const produto = etiquetaProdutoSelect.value === 'CUSTOM' ? etiquetaProdutoCustom.value.trim() : etiquetaProdutoSelect.value;
                if(!produto){ showMessage('Informe o produto', true); return; }
                const dataProd = etiquetaProducaoInput.value || formatDateISO(new Date());
                const validade = etiquetaValidadeInput.value || '';
                const tipo = document.querySelector('input[name="etiqueta-tipo"]:checked').value;
                generateEtiquetas(produto, dataProd, validade, tipo);
            });
        }

        addSupplierForm.addEventListener('submit', async (e) => {
            e.preventDefault();
            const name = document.getElementById('supplier-name').value.trim();
            if (!name) {
                showMessage('Nome do fornecedor é obrigatório', true);
                return;
            }
            try {
                const docRef = await addDoc(colEmp('fornecedores'), { nome: name });
                showMessage('Fornecedor adicionado com sucesso!');
                addSupplierForm.reset();
                appState.suppliers.push({ id: docRef.id, nome: name });
                renderSuppliersList();
                renderSupplierSelect();
                updateSupplierFilter();
                updateShoppingListSupplierFilter();
            } catch (error) {
                console.error('Erro ao adicionar fornecedor:', error);
                showMessage('Erro ao adicionar fornecedor', true);
            }
        });

        if(fcForm){
            fcForm.addEventListener('submit', async (e) => {
                e.preventDefault();
                const nome = fcIngrediente.value;
                const fator = parseFloat(fcFator.value) || 1;
                const preco = parseFloat(fcPreco.value) || 0;
                const unidade = fcUnidade.value.trim();
                if(!nome){ showMessage('Selecione um ingrediente', true); return; }
                try {
                    await setDoc(docEmp('fc', nome), { nome, unidade, fator, preco });
                    showMessage('FC salvo com sucesso!');
                    fcForm.reset();
                } catch(err){
                    console.error('Erro ao salvar FC:', err);
                    showMessage('Erro ao salvar FC', true);
                }
            });

            fcIngrediente.addEventListener('change', () => {
                const stock = getStockItemByName(fcIngrediente.value);
                fcUnidade.value = stock ? stock.unidade : '';
            });

            fcListDiv.addEventListener('click', async (e) => {
                if(e.target.classList.contains('delete-fc')){
                    const name = e.target.getAttribute('data-name');
                    try{
                        await deleteDoc(docEmp('fc', name));
                        showMessage('FC removido');
                    }catch(err){
                        console.error('Erro ao remover FC:', err);
                        showMessage('Erro ao remover FC', true);
                    }
                }
            });
        }

        saveParrillaObsBtn.addEventListener('click', async () => {
            const date = parrillaObsDate.value;
            const text = parrillaObsText.value.trim();
            if (!date || text === '') { showMessage('Preencha data e observação', true); return; }
            try {
                await setDoc(docEmp('observacoesProducao', 'parrilla', 'dias', date), { texto: text });
                showMessage('Observação salva!');
                parrillaObsText.value = '';
                appState.editingObs.parrilla = null;
            } catch (e) {
                console.error('Erro ao salvar observação:', e);
                showMessage('Erro ao salvar observação', true);
            }
        });

        saveCozinhaObsBtn.addEventListener('click', async () => {
            const date = cozinhaObsDate.value;
            const text = cozinhaObsText.value.trim();
            if (!date || text === '') { showMessage('Preencha data e observação', true); return; }
            try {
                await setDoc(docEmp('observacoesProducao', 'cozinha', 'dias', date), { texto: text });
                showMessage('Observação salva!');
                cozinhaObsText.value = '';
                appState.editingObs.cozinha = null;
            } catch (e) {
                console.error('Erro ao salvar observação:', e);
                showMessage('Erro ao salvar observação', true);
            }
        });


        supplierFilter.addEventListener('change', (e) => {
            appState.currentSupplierFilter = e.target.value;
            renderStockList();
        });

        sectorFilter.addEventListener('change', (e) => {
            appState.currentSectorFilter = e.target.value;
            renderProductionList();
        });

        if(balanceSupplierFilter){
            balanceSupplierFilter.addEventListener('change', (e) => {
                appState.currentBalanceSupplierFilter = e.target.value;
                renderBalanceTable();
            });
        }

        if(addIngredienteBtn){
            addIngredienteBtn.addEventListener('click', () => addIngredienteRow());
            addIngredienteRow();
        }

        precoRealInput.addEventListener('input', calculateFichaTotals);
        document.getElementById('ficha-rendimento').addEventListener('input', calculateFichaTotals);

        tabsContainer.addEventListener('click', (e) => {
            if (e.target.classList.contains('tab-button')) {
                const tabName = e.target.getAttribute('data-tab');
                switchTab(tabName);

                // Esconder área de relatórios quando mudar de aba
                if (tabName !== 'reports') {
                    reportDisplayArea.classList.add('hidden');
                    reportDisplayArea.classList.remove('interactive-list');
                }
            }
        });

        document.querySelectorAll('.balance-group-button').forEach(btn => {
            btn.addEventListener('click', () => {
                document.querySelectorAll('.balance-group-button').forEach(b => b.classList.remove('btn-primary'));
                btn.classList.add('btn-primary');
                renderBalanceTable(btn.dataset.bgroup);
            });
        });
        document.querySelectorAll('.balance-view-button').forEach(btn => {
            btn.addEventListener('click', () => switchBalanceView(btn.dataset.view));
        });
        if(historyDateFilter) historyDateFilter.addEventListener('change', loadBalanceHistory);
        if(historyTypeFilter) historyTypeFilter.addEventListener('change', loadBalanceHistory);
        if(historyListDiv) historyListDiv.addEventListener('click', (e) => {
            if(e.target.classList.contains('history-details-btn')){
                const rec = appState.balanceHistoryRecords[e.target.dataset.idx];
                if(rec) showHistoryDetails(rec);
            }
        });
        if(balanceSummaryBtn) balanceSummaryBtn.addEventListener('click', gerarResumoBalanco);
        if(applyBalanceBtn) applyBalanceBtn.addEventListener('click', aplicarBalancoEstoque);
        if(balancePdfBtn) balancePdfBtn.addEventListener('click', exportarBalancoPDF);

        generateStockReportBtn.addEventListener('click', generateStockReportBySupplier);
        generateShoppingListBtn.addEventListener('click', generateShoppingList);
        generateKitchenReportBtn.addEventListener('click', () => generateProductionReport('COZINHA'));
        generateParrillaReportBtn.addEventListener('click', () => generateProductionReport('PARRILLA'));

        fichaForm.addEventListener('submit', async (e) => {
            e.preventDefault();
            const nome = document.getElementById('ficha-nome').value.trim();
            const categoria = document.getElementById('ficha-categoria').value.trim();
            const rendimento = parseFloat(document.getElementById('ficha-rendimento').value) || 1;
            const imagemURL = document.getElementById('ficha-imagem').value.trim();

            const ingredientes = [];
            ingredientesContainer.querySelectorAll('.grid').forEach(row => {
                const sel = row.querySelector('.ingrediente-nome');
                const itemName = sel.value;
                const qLiq = parseFloat(row.querySelector('.q-liquida').value) || 0;
                const fcData = getFCData(itemName);
                const fc = fcData ? fcData.fator : 1;
                const unidade = fcData ? fcData.unidade : row.querySelector('.unidade').value;
                const qBruta = qLiq * fc;
                const custoUnit = fcData ? fcData.preco : 0;
                const custoTotal = qBruta * custoUnit;
                ingredientes.push({ nome: itemName, qtdLiquida: qLiq, unidade, fc, qtdBruta: qBruta, custoUnitario: custoUnit, custoTotal });
            });

            let custoTotal = 0;
            ingredientes.forEach(i => { custoTotal += i.custoTotal; });
            const custoPorPorcao = rendimento > 0 ? custoTotal / rendimento : 0;
            const precoSugerido = appState.currentCMV > 0 ? custoPorPorcao / (appState.currentCMV / 100) : 0;
            const precoReal = parseFloat(precoRealInput.value) || null;
            const cmvReal = precoReal ? (custoPorPorcao / precoReal) * 100 : 0;
            const margemLucro = precoReal ? ((precoReal - custoPorPorcao) / precoReal) * 100 : 0;

            if (!nome || !categoria || ingredientes.length === 0) { showMessage('Preencha todos os campos', true); return; }

            try {
                await addDoc(colEmp('fichasTecnicas'), {
                    nome,
                    categoria,
                    rendimento,
                    ingredientes,
                    custoTotal,
                    custoPorPorcao,
                    cmvAplicado: appState.currentCMV,
                    precoSugerido,
                    precoReal,
                    cmvReal,
                    margemLucro,
                    imagemURL,
                    dataCriacao: new Date()
                });
                showMessage('Ficha adicionada com sucesso!');
                fichaForm.reset();
                ingredientesContainer.innerHTML = '';
                calculateFichaTotals();
            } catch (err) {
                console.error('Erro ao adicionar ficha:', err);
                showMessage('Erro ao adicionar ficha', true);
            }
        });

        calcularCmvBtn.addEventListener('click', calcularCMV);
        mostrarManualBtn.addEventListener('click', () => {
            cmvManualContainer.classList.toggle('hidden');
        });
        importarCmvBtn.addEventListener('click', async () => {
            const calc = calcularCMV();
            let percent = calc.cmvPerc;
            let origem = 'automatica';
            if (!cmvManualContainer.classList.contains('hidden')) {
                const manual = parseFloat(cmvManualInput.value);
                if (!isNaN(manual)) { percent = manual; origem = 'manual'; }
            }
            const now = new Date();
            const docId = `${String(now.getMonth()+1).padStart(2,'0')}_${now.getFullYear()}`;
            try {
                await setDoc(docEmp('cmv', docId), {
                    estoqueInicial: calc.ei,
                    compras: calc.compras,
                    estoqueFinal: calc.ef,
                    despesasFixas: calc.despesas,
                    maoDeObra: calc.mao,
                    receitaBruta: calc.receita,
                    cmvCalculado: calc.cmvCalc,
                    cmvPercentual: percent,
                    origem
                });
                await setDoc(docEmp('config','cmvAplicado'), { valor: percent, origem }, { merge: true });
                showMessage('CMV salvo e aplicado às fichas técnicas!');
            } catch (err) {
                console.error('Erro ao salvar CMV:', err);
                showMessage('Erro ao salvar CMV', true);
            }
        });

    </script>
</body>
</html>

