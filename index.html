<!DOCTYPE html>
<html lang="pt-BR">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>Controle de Estoque</title>

  <!-- Firebase SDKs -->
  <script src="https://www.gstatic.com/firebasejs/11.9.1/firebase-app-compat.js"></script>
  <script src="https://www.gstatic.com/firebasejs/11.9.1/firebase-auth-compat.js"></script>
  <script src="https://www.gstatic.com/firebasejs/11.9.1/firebase-firestore-compat.js"></script>
  <!-- jsPDF para gerar PDF -->
  <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.5.1/jspdf.umd.min.js"></script>

  <style>
    body { font-family: Arial, sans-serif; padding: 20px; max-width: 600px; margin: auto; }
    input, button, select { padding: 10px; margin: 5px 0; width: 100%; }
    .card { border: 1px solid #ccc; padding: 10px; margin-bottom: 10px; }
    .tabs button { padding: 10px; margin-right: 10px; }
    .tabs button.active { background: #ccc; }
    .ocultar { display: none; }
    .popup-overlay { position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: rgba(0,0,0,0.6); display: flex; align-items: center; justify-content: center; z-index: 9999; }
    .popup-content { background: #fff; padding: 20px; border-radius: 10px; width: 90%; max-width: 600px; max-height: 80vh; overflow-y: auto; }
    .popup-content input { width: 60px; }
    .popup-header { display: flex; justify-content: space-between; align-items: center; }
  </style>
</head>
<body>
  <h1>Gerenciar Estoque da Cozinha</h1>

  <div id="login-section">
    <input type="email" id="email" placeholder="Email" />
    <input type="password" id="password" placeholder="Senha" />
    <button onclick="login()">Entrar</button>
    <p id="login-error" style="color:red"></p>
  </div>

  <div id="app-section" style="display:none">
    <h2>Bem-vindo ao Sistema!</h2>
    <p>Login realizado com sucesso!</p>

    <div class="tabs">
      <button onclick="mostrarAba('estoque')" id="btn-estoque">Estoque</button>
      <button onclick="mostrarAba('producao')" id="btn-producao">ProduÃ§Ã£o</button>
    </div>

    <div id="aba-estoque" style="display:block">
      <h3>Itens do Estoque</h3>
      <select id="filtro-fornecedor" onchange="filtrarEstoque()"></select>
      <div id="estoque-list"></div>
      <button onclick="abrirPopupConfirmacaoCompras()">ðŸ“‹ Gerar Lista de Compras (PDF)</button>
    </div>

    <div id="aba-producao" style="display:none">
      <h3>Cadastro de ProduÃ§Ã£o</h3>
      <input type="text" id="item-producao" placeholder="Nome do item" />
      <input type="text" id="unidade-producao" placeholder="Unidade (kg, L, porÃ§Ã£o...)" />
      <input type="number" id="quantidade-producao" placeholder="Quantidade" />
      <button onclick="salvarProducao()">Salvar item produzido</button>
      <div id="producao-list"></div>
    </div>
  </div>

  <div id="popup-confirmacao" class="popup-overlay" style="display:none">
    <div class="popup-content">
      <div class="popup-header">
        <h3>Confirmar Lista de Compras</h3>
        <button onclick="document.getElementById('popup-confirmacao').style.display='none'">âœ–</button>
      </div>
      <div id="lista-confirmacao"></div>
      <button onclick="gerarPDFConfirmado()">Gerar PDF</button>
    </div>
  </div>

  <script>
    let itensParaCompraConfirmados = [];

    window.abrirPopupConfirmacaoCompras = function () {
      const container = document.getElementById("lista-confirmacao");
      itensParaCompraConfirmados = [];
      container.innerHTML = "";

      todosItensEstoque.forEach(item => {
        const atual = item.atual || 0;
        const ideal = item.ideal || 0;
        const comprar = ideal - atual;

        if (comprar > 0) {
          const id = `${item.item}_${item.fornecedor}`;
          itensParaCompraConfirmados.push({ ...item, comprar });

          container.innerHTML += `
            <div class='card' id='card-${id}'>
              <b>${item.item}</b> (${item.unidade})<br>
              Atual: ${atual} | Ideal: ${ideal}<br>
              Comprar: <input type='number' id='input-${id}' value='${comprar}' />
              <button onclick="document.getElementById('card-${id}').remove()">Excluir</button>
            </div>`;
        }
      });

      document.getElementById("popup-confirmacao").style.display = "flex";
    }

    window.gerarPDFConfirmado = function () {
      const { jsPDF } = window.jspdf;
      const doc = new jsPDF();
      const dataAtual = new Date().toLocaleDateString();
      doc.text("Lista de Compras Confirmada", 15, 10);
      doc.setFontSize(10);
      doc.text("Data: " + dataAtual, 15, 16);

      let y = 25;
      const agrupado = {};

      itensParaCompraConfirmados.forEach(item => {
        const id = `${item.item}_${item.fornecedor}`;
        const campo = document.getElementById(`input-${id}`);
        const qtd = parseFloat(campo?.value || 0);
        if (qtd <= 0) return;
        if (!agrupado[item.fornecedor]) agrupado[item.fornecedor] = [];
        agrupado[item.fornecedor].push({ ...item, comprar: qtd });
      });

      Object.keys(agrupado).forEach(fornecedor => {
        doc.setFont(undefined, 'bold');
        doc.text(fornecedor, 15, y);
        y += 6;
        doc.setFont(undefined, 'normal');
        agrupado[fornecedor].forEach(item => {
          doc.text(`- ${item.item}: Comprar ${item.comprar} ${item.unidade}`, 15, y);
          y += 5;
        });
        y += 3;
      });

      doc.save("lista_compras_confirmada.pdf");
      document.getElementById("popup-confirmacao").style.display = "none";
    }
  </script>
</body>
</html>
