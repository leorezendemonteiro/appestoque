<!DOCTYPE html>
<html lang="pt-BR">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0"/>
  <title>App Estoque Cozinha</title>
  <script src="https://cdn.tailwindcss.com"></script>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.5.1/jspdf.umd.min.js"></script>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/html2canvas/1.4.1/html2canvas.min.js"></script>
  <style>
    .tab-button.active { border-color: #3b82f6; color: #3b82f6; background-color: #eff6ff; }
    .tab-content { display: none; }
    .tab-content.active { display: block; }
    #report-display-area.interactive-list {
      max-height: 60vh;
      overflow-y: auto;
      border: 1px solid #e5e7eb;
    }
    .print-area {
      font-family: Arial, sans-serif;
    }
    .print-area h1 {
      font-size: 18px;
      border-bottom: 1px solid #ccc;
      padding-bottom: 10px;
      margin-bottom: 20px;
    }
    .print-area h2 {
      font-size: 16px;
      margin-top: 15px;
    }
    .print-area table {
      width: 100%;
      border-collapse: collapse;
      font-size: 12px;
      margin-top: 10px;
    }
    .print-area th, .print-area td {
      border: 1px solid #ddd;
      padding: 8px;
      text-align: left;
    }
    .print-area thead {
      background-color: #f2f2f2;
    }
  </style>
</head>
<body class="bg-gray-100">
  <div id="app-container" class="w-full max-w-2xl mx-auto py-8 px-4">
    <div id="login-view" class="bg-white p-8 rounded-xl shadow-lg max-w-md mx-auto">
      <h1 class="text-2xl font-bold text-center text-gray-800 mb-6">Controle de Estoque</h1>
      <form id="login-form">
        <div class="mb-4">
          <label for="login-email" class="block text-gray-700 text-sm font-bold mb-2">Email</label>
          <input type="email" id="login-email" name="email" class="shadow appearance-none border rounded w-full py-2 px-3 text-gray-700" required>
        </div>
        <div class="mb-6">
          <label for="login-password" class="block text-gray-700 text-sm font-bold mb-2">Senha</label>
          <input type="password" id="login-password" name="password" class="shadow appearance-none border rounded w-full py-2 px-3 text-gray-700" required>
        </div>
        <div class="flex flex-col space-y-4">
          <button type="submit" class="bg-blue-500 hover:bg-blue-700 text-white font-bold py-2 px-4 rounded">Entrar</button>
          <button type="button" id="show-signup-btn" class="text-center text-sm text-blue-500 hover:text-blue-700">Não tenho conta, quero me cadastrar</button>
        </div>
      </form>
    </div>
    <div id="signup-view" class="bg-white p-8 rounded-xl shadow-lg max-w-md mx-auto hidden">
      <h1 class="text-2xl font-bold text-center text-gray-800 mb-6">Criar Nova Conta</h1>
      <form id="signup-form">
        <div class="mb-4">
          <label for="signup-email" class="block text-gray-700 text-sm font-bold mb-2">Email</label>
          <input type="email" id="signup-email" name="email" class="shadow appearance-none border rounded w-full py-2 px-3 text-gray-700" required>
        </div>
        <div class="mb-6">
          <label for="signup-password" class="block text-gray-700 text-sm font-bold mb-2">Senha</label>
          <input type="password" id="signup-password" name="password" class="shadow appearance-none border rounded w-full py-2 px-3 text-gray-700" required>
        </div>
        <div class="flex flex-col space-y-4">
          <button type="submit" class="bg-green-500 hover:bg-green-700 text-white font-bold py-2 px-4 rounded">Cadastrar</button>
          <button type="button" id="show-login-btn" class="text-center text-sm text-blue-500 hover:text-blue-700">Já tenho uma conta</button>
        </div>
      </form>
    </div>
    <div id="main-app-view" class="hidden">
      <header class="bg-white p-4 rounded-xl shadow-lg mb-8">
        <div class="flex justify-between items-center">
          <div>
            <h1 class="text-xl font-bold text-gray-800">App de Gestão</h1>
            <p id="user-email" class="text-xs text-gray-500"></p>
          </div>
          <button id="logout-btn" class="bg-red-500 hover:bg-red-700 text-white font-bold py-2 px-4 rounded text-sm">Sair</button>
        </div>
      </header>
      <div class="mb-8">
        <div class="border-b border-gray-200">
          <nav id="tabs-container" class="-mb-px flex space-x-4" aria-label="Tabs">
            <button data-tab="stock" class="tab-button whitespace-nowrap py-4 px-1 border-b-2 font-medium text-sm">Estoque</button>
            <button data-tab="production" class="tab-button whitespace-nowrap py-4 px-1 border-b-2 font-medium text-sm">Produção</button>
            <button data-tab="reports" class="tab-button whitespace-nowrap py-4 px-1 border-b-2 font-medium text-sm">Relatórios</button>
          </nav>
        </div>
      </div>
      <div id="app-content">
  <div id="tab-stock" class="tab-content space-y-8">
    <div class="bg-white p-6 rounded-xl shadow-lg">
      <h2 class="text-lg font-semibold mb-4 text-gray-700">Adicionar Produto ao Estoque</h2>
      <form id="add-item-form" class="grid grid-cols-1 sm:grid-cols-2 gap-4">
        <input type="text" id="product-name" placeholder="Nome do Produto" class="sm:col-span-2 shadow appearance-none border rounded w-full py-2 px-3 text-gray-700" required>
        <input type="text" id="product-supplier" placeholder="Fornecedor" class="shadow appearance-none border rounded w-full py-2 px-3 text-gray-700">
        <input type="number" id="product-quantity" placeholder="Qtd. Atual" class="shadow appearance-none border rounded w-full py-2 px-3 text-gray-700" step="any" required>
        <input type="number" id="product-min" placeholder="Qtd. Mínima" class="shadow appearance-none border rounded w-full py-2 px-3 text-gray-700" step="any">
        <input type="number" id="product-ideal" placeholder="Qtd. Ideal" class="shadow appearance-none border rounded w-full py-2 px-3 text-gray-700" step="any">
        <select id="product-unit" class="shadow appearance-none border rounded w-full py-2 px-3 text-gray-700 bg-white">
          <option>un</option><option>kg</option><option>g</option><option>lt</option><option>ml</option>
        </select>
        <button type="submit" class="sm:col-span-2 bg-blue-500 hover:bg-blue-700 text-white font-bold py-2 px-4 rounded">Adicionar</button>
      </form>
    </div>
    <div class="bg-white p-6 rounded-xl shadow-lg">
      <div class="flex justify-between items-center mb-4">
        <h2 class="text-lg font-semibold text-gray-700">Itens no Estoque</h2>
        <select id="supplier-filter" class="shadow-sm appearance-none border rounded py-2 px-3 text-gray-700 bg-white text-sm"></select>
      </div>
      <div id="stock-list" class="space-y-3"></div>
    </div>
  </div>
  <div id="tab-production" class="tab-content space-y-8">
    <div class="bg-white p-6 rounded-xl shadow-lg">
      <h2 class="text-lg font-semibold mb-4 text-gray-700">Adicionar Item à Produção</h2>
      <form id="add-production-form" class="grid grid-cols-1 sm:grid-cols-2 gap-4">
        <input type="text" id="production-name" placeholder="Nome do Produto" class="sm:col-span-2 shadow appearance-none border rounded w-full py-2 px-3 text-gray-700" required>
        <select id="production-sector" class="shadow appearance-none border rounded w-full py-2 px-3 text-gray-700 bg-white">
          <option value="COZINHA">COZINHA</option><option value="PARRILLA">PARRILLA</option>
        </select>
        <input type="number" id="production-quantity" placeholder="Qtd" class="shadow appearance-none border rounded w-full py-2 px-3 text-gray-700" step="any" required>
        <select id="production-unit" class="shadow appearance-none border rounded w-full py-2 px-3 text-gray-700 bg-white">
          <option>porção</option><option>kg</option><option>lt</option><option>un</option>
        </select>
        <button type="submit" class="sm:col-span-2 bg-green-500 hover:bg-green-700 text-white font-bold py-2 px-4 rounded">Adicionar</button>
      </form>
    </div>
    <div class="bg-white p-6 rounded-xl shadow-lg">
      <div class="flex justify-between items-center mb-4">
        <h2 class="text-lg font-semibold text-gray-700">Itens em Produção</h2>
        <select id="sector-filter" class="shadow-sm appearance-none border rounded py-2 px-3 text-gray-700 bg-white text-sm">
          <option value="TODOS">TODOS</option>
          <option value="COZINHA">COZINHA</option>
          <option value="PARRILLA">PARRILLA</option>
        </select>
      </div>
      <div id="production-list" class="space-y-3"></div>
    </div>
  </div>
  <div id="tab-reports" class="tab-content space-y-8">
    <div class="bg-white p-6 rounded-xl shadow-lg">
      <h2 class="text-lg font-semibold mb-4 text-gray-700">Relatórios de Estoque</h2>
      <div class="flex flex-col sm:flex-row gap-4">
        <button id="generate-stock-report-btn" class="flex-1 bg-gray-600 hover:bg-gray-700 text-white font-bold py-2 px-4 rounded">Relatório Geral de Estoque (PDF)</button>
        <button id="generate-shopping-list-btn" class="flex-1 bg-orange-500 hover:bg-orange-600 text-white font-bold py-2 px-4 rounded">Gerar Lista de Compras</button>
      </div>
    </div>
    <div class="bg-white p-6 rounded-xl shadow-lg">
      <h2 class="text-lg font-semibold mb-4 text-gray-700">Relatórios de Produção</h2>
      <div class="flex flex-col sm:flex-row gap-4">
        <button id="generate-kitchen-report-btn" class="flex-1 bg-teal-600 hover:bg-teal-700 text-white font-bold py-2 px-4 rounded">Produção Cozinha (PDF)</button>
        <button id="generate-parrilla-report-btn" class="flex-1 bg-red-700 hover:bg-red-800 text-white font-bold py-2 px-4 rounded">Produção Parrilla (PDF)</button>
      </div>
    </div>
    <div id="report-display-area" class="bg-white rounded-xl shadow-lg hidden"></div>
  </div>
</div>
    </div>
  </div>
  <script type="module">
  import { initializeApp } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-app.js";
  import { getAuth, createUserWithEmailAndPassword, signInWithEmailAndPassword, onAuthStateChanged, signOut } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-auth.js";
  import { getFirestore, collection, addDoc, deleteDoc, updateDoc, doc, onSnapshot, query } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-firestore.js";

  const firebaseConfig = {
    apiKey: "AIzaSyBJbyfICQFEfzL7EKbaH-08mQmZWOM8FhU",
    authDomain: "appestoquecozinha.firebaseapp.com",
    projectId: "appestoquecozinha",
    storageBucket: "appestoquecozinha.firebasestorage.app",
    messagingSenderId: "705934517110",
    appId: "1:705934517110:web:b4d5b79059feb7e6485057"
  };

  const app = initializeApp(firebaseConfig);
  const auth = getAuth(app);
  const db = getFirestore(app);

  const loginView = document.getElementById('login-view');
  const signupView = document.getElementById('signup-view');
  const mainAppView = document.getElementById('main-app-view');
  const userEmail = document.getElementById('user-email');
  const showSignupBtn = document.getElementById('show-signup-btn');
  const showLoginBtn = document.getElementById('show-login-btn');
  const logoutBtn = document.getElementById('logout-btn');

  showSignupBtn.onclick = () => {
    loginView.classList.add('hidden');
    signupView.classList.remove('hidden');
  };
  showLoginBtn.onclick = () => {
    signupView.classList.add('hidden');
    loginView.classList.remove('hidden');
  };

  document.getElementById('login-form').addEventListener('submit', async (e) => {
    e.preventDefault();
    const email = document.getElementById('login-email').value;
    const password = document.getElementById('login-password').value;
    try {
      await signInWithEmailAndPassword(auth, email, password);
    } catch (error) {
      alert('Erro ao fazer login: ' + error.message);
    }
  });

  document.getElementById('signup-form').addEventListener('submit', async (e) => {
    e.preventDefault();
    const email = document.getElementById('signup-email').value;
    const password = document.getElementById('signup-password').value;
    try {
      await createUserWithEmailAndPassword(auth, email, password);
      alert('Conta criada com sucesso! Faça login.');
      signupView.classList.add('hidden');
      loginView.classList.remove('hidden');
    } catch (error) {
      alert('Erro ao cadastrar: ' + error.message);
    }
  });

  logoutBtn.onclick = () => {
    signOut(auth);
  };

  onAuthStateChanged(auth, (user) => {
    if (user) {
      loginView.classList.add('hidden');
      signupView.classList.add('hidden');
      mainAppView.classList.remove('hidden');
      userEmail.textContent = user.email;
    } else {
      mainAppView.classList.add('hidden');
      loginView.classList.remove('hidden');
    }
  });

  document.getElementById('tabs-container').addEventListener('click', (e) => {
    if (e.target.matches('.tab-button')) {
      document.querySelectorAll('.tab-button').forEach(btn => btn.classList.remove('active'));
      e.target.classList.add('active');
      document.querySelectorAll('.tab-content').forEach(tab => tab.classList.remove('active'));
      document.getElementById(`tab-${e.target.dataset.tab}`).classList.add('active');
    }
  });

  let appState = { stockItems: [], productionItems: [], currentSupplierFilter: 'TODOS', currentSectorFilter: 'TODOS' };

// FUNÇÕES DE ESCAPE E RENDERIZAÇÃO
function escapeHtml(text) {
  return text?.replace(/&/g, "&amp;").replace(/</g, "&lt;").replace(/>/g, "&gt;").replace(/\"/g, "&quot;").replace(/'/g, "&#039;") || "";
}

function renderStockList(items) {
  const container = document.getElementById('stock-list');
  container.innerHTML = "";
  if (items.length === 0) {
    container.innerHTML = "<p class='text-gray-500 text-center p-4'>Nenhum item no estoque.</p>";
    return;
  }
  items.forEach(item => {
    const div = document.createElement('div');
    div.className = "flex items-center justify-between bg-gray-50 p-3 rounded-lg";
    div.innerHTML = `<div><p class='font-semibold'>${escapeHtml(item.item)}</p><p class='text-sm'>Fornecedor: ${escapeHtml(item.fornecedor || '')}</p><p class='text-sm'>Atual: ${item.atual} ${item.unidade}</p></div><button data-id='${item.id}' class='delete-stock bg-red-500 text-white px-2 py-1 rounded text-xs'>Excluir</button>`;
    container.appendChild(div);
  });
  document.querySelectorAll('.delete-stock').forEach(btn => {
    btn.onclick = async () => {
      const user = auth.currentUser;
      if (user) await deleteDoc(doc(db, "users", user.uid, "stock", btn.dataset.id));
    };
  });
}

function renderProductionList(items) {
  const container = document.getElementById('production-list');
  container.innerHTML = "";
  if (items.length === 0) {
    container.innerHTML = "<p class='text-gray-500 text-center p-4'>Nenhum item em produção.</p>";
    return;
  }
  items.forEach(item => {
    const div = document.createElement('div');
    div.className = "flex items-center justify-between bg-gray-50 p-3 rounded-lg";
    div.innerHTML = `<div><p class='font-semibold'>${escapeHtml(item.item)}</p><p class='text-sm'>Setor: ${escapeHtml(item.setor)}</p><p class='text-sm'>Qtd: ${item.quantidade} ${item.unidade}</p></div><button data-id='${item.id}' class='delete-prod bg-red-500 text-white px-2 py-1 rounded text-xs'>Excluir</button>`;
    container.appendChild(div);
  });
  document.querySelectorAll('.delete-prod').forEach(btn => {
    btn.onclick = async () => {
      const user = auth.currentUser;
      if (user) await deleteDoc(doc(db, "users", user.uid, "production", btn.dataset.id));
    };
  });
}

// FORM STOCK
const addItemForm = document.getElementById('add-item-form');
addItemForm.onsubmit = async (e) => {
  e.preventDefault();
  const user = auth.currentUser;
  if (!user) return;
  const data = {
    item: addItemForm['product-name'].value,
    fornecedor: addItemForm['product-supplier'].value,
    atual: parseFloat(addItemForm['product-quantity'].value),
    minima: parseFloat(addItemForm['product-min'].value),
    ideal: parseFloat(addItemForm['product-ideal'].value),
    unidade: addItemForm['product-unit'].value,
    timestamp: new Date()
  };
  await addDoc(collection(db, "users", user.uid, "stock"), data);
  addItemForm.reset();
};

// FORM PRODUCTION
const addProductionForm = document.getElementById('add-production-form');
addProductionForm.onsubmit = async (e) => {
  e.preventDefault();
  const user = auth.currentUser;
  if (!user) return;
  const data = {
    item: addProductionForm['production-name'].value,
    setor: addProductionForm['production-sector'].value,
    quantidade: parseFloat(addProductionForm['production-quantity'].value),
    unidade: addProductionForm['production-unit'].value,
    timestamp: new Date()
  };
  await addDoc(collection(db, "users", user.uid, "production"), data);
  addProductionForm.reset();
};

// FILTROS
const supplierFilter = document.getElementById('supplier-filter');
const sectorFilter = document.getElementById('sector-filter');
supplierFilter.onchange = () => {
  appState.currentSupplierFilter = supplierFilter.value;
  const filtered = appState.stockItems.filter(item =>
    appState.currentSupplierFilter === 'TODOS' || item.fornecedor === appState.currentSupplierFilter);
  renderStockList(filtered);
};
sectorFilter.onchange = () => {
  appState.currentSectorFilter = sectorFilter.value;
  const filtered = appState.productionItems.filter(item =>
    appState.currentSectorFilter === 'TODOS' || item.setor === appState.currentSectorFilter);
  renderProductionList(filtered);
};

// LISTENERS FIRESTORE
onAuthStateChanged(auth, (user) => {
  if (user) {
    const stockRef = collection(db, "users", user.uid, "stock");
    onSnapshot(stockRef, (snapshot) => {
      appState.stockItems = snapshot.docs.map(doc => ({ id: doc.id, ...doc.data() }));
      const filtered = appState.stockItems.filter(item =>
        appState.currentSupplierFilter === 'TODOS' || item.fornecedor === appState.currentSupplierFilter);
      renderStockList(filtered);
      const suppliers = ['TODOS', ...new Set(appState.stockItems.map(i => i.fornecedor || ''))];
      supplierFilter.innerHTML = suppliers.map(s => `<option value='${s}'>${s}</option>`).join('');
    });

    const prodRef = collection(db, "users", user.uid, "production");
    onSnapshot(prodRef, (snapshot) => {
      appState.productionItems = snapshot.docs.map(doc => ({ id: doc.id, ...doc.data() }));
      const filtered = appState.productionItems.filter(item =>
        appState.currentSectorFilter === 'TODOS' || item.setor === appState.currentSectorFilter);
      renderProductionList(filtered);
    });
  }
});

// RELATÓRIOS EM PDF
  const reportDisplayArea = document.getElementById('report-display-area');
  const generateStockReportBtn = document.getElementById('generate-stock-report-btn');
  const generateKitchenReportBtn = document.getElementById('generate-kitchen-report-btn');
  const generateParrillaReportBtn = document.getElementById('generate-parrilla-report-btn');

  async function generatePdf(title, contentHtml) {
    const container = document.createElement('div');
    container.className = 'print-area';
    container.innerHTML = contentHtml;
    document.body.appendChild(container);
    const canvas = await html2canvas(container);
    const { jsPDF } = window.jspdf;
    const pdf = new jsPDF('p', 'mm', 'a4');
    const imgData = canvas.toDataURL('image/png');
    const pageWidth = pdf.internal.pageSize.getWidth();
    const pageHeight = pdf.internal.pageSize.getHeight();
    const imgProps = pdf.getImageProperties(imgData);
    const pdfHeight = (imgProps.height * pageWidth) / imgProps.width;
    pdf.addImage(imgData, 'PNG', 0, 0, pageWidth, pdfHeight);
    pdf.save(`${title}.pdf`);
    document.body.removeChild(container);
  }

  generateStockReportBtn.onclick = () => {
    const grouped = {};
    appState.stockItems.forEach(item => {
      const fornecedor = item.fornecedor || 'Sem Fornecedor';
      if (!grouped[fornecedor]) grouped[fornecedor] = [];
      grouped[fornecedor].push(item);
    });
    let html = '<h1>Relatório Geral de Estoque</h1>';
    for (let fornecedor in grouped) {
      html += `<h2>Fornecedor: ${fornecedor}</h2><table><thead><tr><th>Produto</th><th>Qtd</th><th>Unidade</th></tr></thead><tbody>`;
      grouped[fornecedor].forEach(i => {
        html += `<tr><td>${escapeHtml(i.item)}</td><td>${i.atual}</td><td>${i.unidade}</td></tr>`;
      });
      html += '</tbody></table>';
    }
    generatePdf('relatorio_estoque', html);
  };

  generateKitchenReportBtn.onclick = () => {
    const items = appState.productionItems.filter(i => i.setor === 'COZINHA');
    let html = '<h1>Relatório de Produção - Cozinha</h1><table><thead><tr><th>Produto</th><th>Qtd</th><th>Unidade</th></tr></thead><tbody>';
    items.forEach(i => {
      html += `<tr><td>${escapeHtml(i.item)}</td><td>${i.quantidade}</td><td>${i.unidade}</td></tr>`;
    });
    html += '</tbody></table>';
    generatePdf('producao_cozinha', html);
  };

  generateParrillaReportBtn.onclick = () => {
    const items = appState.productionItems.filter(i => i.setor === 'PARRILLA');
    let html = '<h1>Relatório de Produção - Parrilla</h1><table><thead><tr><th>Produto</th><th>Qtd</th><th>Unidade</th></tr></thead><tbody>';
    items.forEach(i => {
      html += `<tr><td>${escapeHtml(i.item)}</td><td>${i.quantidade}</td><td>${i.unidade}</td></tr>`;
    });
    html += '</tbody></table>';
    generatePdf('producao_parrilla', html);
  };
</script>
</body>
</html>
